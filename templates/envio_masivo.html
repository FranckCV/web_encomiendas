{% extends 'MAESTRA_GENERAL.html' %}

{% block titulo %}
Registro de Env√≠os Masivos
{% endblock %}

{% block estilos %}
<link rel="stylesheet" href="/static/css/registro_envio.css">
<link rel="stylesheet" href="/static/css/envios_masivos.css">
{% endblock %}

{% block contenido %}


<div class="navigation-links">
  <a href="{{ url_for('tipos_envio') }}" class="back-link">‚Üê Regresar</a>
</div>

<div class="container">
  <h1 class="titulo-envio">REGISTRO DE ENV√çOS MASIVOS</h1>

  <div class="steps-container">
    <div class="step active">
      <div class="circle">
        <img src="/static/img/usuario.png" alt="Datos personales" />
      </div>
      <p>Datos personales</p>
    </div>
    <div class="line"></div>
    <div class="step">
      <div class="circle">
        <img src="/static/img/chek.png" alt="Confirma tus datos" />
      </div>
      <p>Confirma tus datos</p>
    </div>
    <div class="line"></div>
    <div class="step">
      <div class="circle">
        <img src="/static/img/medio.png" alt="Medios de pago" />
      </div>
      <p>Medios de pago</p>
    </div>
  </div>

  <form id="formulario-envio" class="formulario">
    <!-- SECCI√ìN: QUI√âN ENV√çA -->
    <div id="seccion-quien-envia" >
      <h2 class="titulo-seccion">¬øQui√©n env√≠a?</h2>

      <div id="seccion_remitente">

            <div class="campo-grupo">
              <select id="remitente-tipo-doc" required>
                <option disabled selected value="">Seleccione tipo de documento</option>
                {% for fila in nombre_doc %}
                  <option value="{{ fila[0] }}">{{ fila[1] }}</option>
                {% endfor %}
              </select>
            </div>

            <div class="campo-grupo">
              <input type="text" id="remitente-numero-doc" placeholder="N√∫mero de documento" required>
                <small id="mensaje-validacion-numero" style="color: red; display: none;"></small>

            </div>

            <div class="campo-grupo">
              <input type="text" id="remitente-telefono" placeholder="N√∫mero de tel√©fono" required>
                <small id="mensaje-validacion-telefono" style="color: red; display: none;"></small>

            </div>

            <div class="campo-grupo">
              <input type="text" id="remitente-nombre" placeholder="Nombre completo" required>
              <small id="mensaje-validacion-nombre" style="color: red; display: none;"></small>

            </div>

            <div class="campo-grupo">
              <input type="email" id="remitente-email" placeholder="Email" required>
              <small id="mensaje-validacion-email" style="color: red; display: none;"></small>
            </div>

        </div>
    </div>
    <div id="desde-donde-envia" >
      <h2 class="titulo-seccion">¬øDesde d√≥nde env√≠a?</h2>

      <div id="seccion-origen">
         <div class="campos-envio">
              <div class="campo-grupo">
                  <label>Departamento *</label>
                  <select id="origen-departamento" required>
                  </select>
                </div>

                <div class="campo-grupo">
                  <label>Provincia *</label>
                  <select id="origen-provincia" required>
                  </select>
                </div>

                <div class="campo-grupo">
                  <label>Distrito *</label>
                  <select id="origen-distrito" required>
                  </select>
                </div>
          </div>
        </div>
    </div>
    <!-- SECCI√ìN: ENV√çOS MASIVOS CON PESTA√ëAS -->
    <div id="seccion-masiva" style="display: block;">
      <div class="seccion-masiva">
        <h2 class="titulo-seccion">Registro de encomiendas</h2>
        
        <!-- Sistema de Pesta√±as -->
        <div class="tabs-container">
          <div class="tabs-nav">
            <button type="button" class="tab-btn active" data-tab="destino">
              üìç Destino
            </button>
            <button type="button" class="tab-btn" data-tab="paquete">
              üì¶ Paquete
            </button>
            <button type="button" class="tab-btn" data-tab="destinatario">
              üë§ Destinatario
            </button>
          </div>

          <!-- Contenido de las pesta√±as -->
          <div class="tabs-content">
            
            <!-- PESTA√ëA DESTINO -->
            <div class="tab-panel active" id="tab-destino">
              <div class="campos-envio">
                <div class="campo-grupo">
                  <label>Tipo de recepci√≥n *</label>
                  <select id="m-tipoEntrega" required onchange="mostrarCamposDestino()">
                    <option disabled selected value="">Seleccione tipo de recepci√≥n</option>
                      {% for fila in nombre_rep %}
                        <option value="{{ fila[0] }}">{{ fila[1] }}</option>
                      {% endfor %}
                  </select>
                </div>

                <div class="campo-grupo">
                  <label>Departamento *</label>
                  <select id="select-departamento" required>
                    <option disabled selected value="">Elija lugar de origen primero</option>
                  </select>
                </div>

                <div class="campo-grupo">
                  <label>Provincia *</label>
                  <select id="select-provincia" required>
                  <option disabled selected value="">Elija lugar de origen primero</option>

                  </select>
                </div>

                <div class="campo-grupo">
                  <label>Distrito *</label>
                  <select id="select-distrito" required>
                         <option disabled selected value="">Elija lugar de origen primero</option>
                  </select>
                </div>

                <!-- Direcci√≥n y Referencia: solo para domicilio -->
                <div class="campo-grupo" id="grupo-direccion" style="display:none;">
                  <label>Direcci√≥n *</label>
                  <input type="text" id="m-direccion" placeholder="Av./Jr./Calle Nombre #123" required>
                  <small id="mensaje-validacion-direccion" style="color: red; display: none;"></small>
                </div>

               <!-- <div class="campo-grupo" id="grupo-referencia" style="display:none;">
                  <label>Referencia</label>
                  <input type="text" id="m-referencia" placeholder="Entre calles, cerca de...">
                  <small id="mensaje-validacion-referencia" style="color: red; display: none;"></small>
                </div>-->

                <!-- Tienda: solo para agencia -->
                <div class="campo-grupo" id="grupo-tienda" style="display:none;">
                  <label>Sucursal *</label>
                  <select id="select-sucursal" required>
                  </select>
                </div>
              </div>
            </div>

            <!-- PESTA√ëA PAQUETE -->
            <div class="tab-panel" id="tab-paquete">
              <div class="campos-envio">
                <div class="campo-grupo">
                  <label>Tipo de empaque *</label>
                    <select id="m-tipoEmpaque" required onchange="toggleFolios(); toggleArticulos();">
                      <option disabled selected value="">Seleccione tipo de empaque</option>
                      {% for fila in empaque %}
                        <option value="{{ fila[0] }}">{{ fila[1] }}</option>
                      {% endfor %}
                  </select>
                </div>
                
                <div class="campo-grupo" id="grupo-articulos" style="display:none;">
                      <label>Tipo de contenido *</label>
                      <select id="m-tipoArticulo" required>
                      <option disabled selected value="">Seleccione tipo de contenido</option>
                      {% for fila in articulos %}
                        <option value="{{ fila[0] }}">{{ fila[1] }}</option>
                      {% endfor %}
                      </select>
                  </div>

                <div class="campo-grupo">
                  <label>Valor (S/) *</label>
                  <input type="number" id="m-valorEnvio" step="0.01" min="0" placeholder="0.00" required>
                   <small id="mensaje-validacion-email" style="color: red; display: none;"></small>
                </div>
                
                <div class="campo-grupo">
                  <label>Peso (kg) *</label>
                  <input type="number" id="m-peso" step="0.001" min="0.001" placeholder="0.00" required>
                  <small id="mensaje-validacion-email" style="color: red; display: none;"></small>
                </div>
                
                <div class="campo-grupo">
                  <label>Largo (cm) *</label>
                  <input type="number" id="m-largo" step="0.1" min="0.1" placeholder="0.0" required>
                  <small id="mensaje-validacion-email" style="color: red; display: none;"></small>
                </div>
                
                <div class="campo-grupo">
                  <label>Ancho (cm) *</label>
                  <input type="number" id="m-ancho" step="0.1" min="0.1" placeholder="0.0" required>
                   <small id="mensaje-validacion-email" style="color: red; display: none;"></small>
                </div>
                
                <div class="campo-grupo">
                  <label>Alto (cm) *</label>
                  <input type="number" id="m-alto" step="0.1" min="0.1" placeholder="0.0" required>
                </div>

                <div class="campo-grupo" id="grupo-folios" style="display:none;">
                  <label># Folios *</label>
                  <input type="number" id="m-folios" min="1" placeholder="Cantidad de hojas" required>
                </div>

                <div class="campo-grupo campo-descripcion">
                  <label>Descripci√≥n(Opcional)</label>
                  <textarea id="m-descripcionArticulo" placeholder="Descripci√≥n detallada del contenido" required></textarea>
                </div>
              </div>
            </div>

            <!-- PESTA√ëA DESTINATARIO -->
            <div class="tab-panel" id="tab-destinatario">
              <div class="campos-envio">
                <div class="campo-grupo">
                  <label>Tipo de documento *</label>
                  <select id="m-tipoDocumento" required onchange="mostrarCamposReceptor()">
                    <option disabled selected value="">Seleccione tipo de documento</option>
                    {% for fila in nombre_doc %}
                      <option value="{{ fila[0] }}">{{ fila[1] }}</option>
                    {% endfor %}
                  </select>
                </div>
                
                <div class="campo-grupo">
                  <label>Nro de documento *</label>
                  <input type="text" id="m-nroDocumento" placeholder="N√∫mero de documento" required>
                </div>
                
                <div class="campo-grupo">
                  <label>Celular *</label>
                  <input type="tel" id="m-celular" required placeholder="999999999" pattern="[0-9]{9}" title="Ingrese 9 d√≠gitos">
                </div>





                <!-- Campos para RUC -->


                    <div class="campo-grupo" id="campo-razon-ruc">
                      <label>Raz√≥n Social *</label>
                      <input type="text" id="m-razonSocial" placeholder="Nombre de la empresa">
                    </div>

                    <div class="campo-grupo"  id="campo-contacto-ruc">
                      <label>Contacto *</label>
                      <input type="text" id="m-contacto" placeholder="Persona de contacto">
                    </div>


                <!-- Campos para personas naturales -->
                <div id="campos-nombres" class="campo-grupo" style="display:none;">
                  <label>Nombres *</label>
                  <input type="text" id="m-nombres" placeholder="Nombres completos">
                </div>
                
                <div id="campos-apellidos" class="campo-grupo" style="display:none;">
                  <label>Apellidos *</label>
                  <input type="text" id="m-apellidos" placeholder="Apellidos completos">
                </div>




              </div>
            </div>
          </div>
        </div>

        <!-- Botones de acci√≥n -->
        <div class="form-actions">
          <button type="button" class="btn-agregar" onclick="agregarEnvio()"> + Agregar env√≠o</button>
          <button type="button" class="btn-limpiar" onclick="limpiarFormularioMasivo()">Limpiar formulario</button>
        </div>
      </div>

      <!-- Tabla de env√≠os -->
      <div class="tabla-envios">
        <div class="tabla-header">
          <h3>üì¶ Env√≠os registrados</h3>
          <div class="stats">
            <div class="stat-item">
              <div class="stat-value" id="totalEnvios">0</div>
              <div class="stat-label">Total Env√≠os</div>
            </div>
            <div class="stat-item">
              <div class="stat-value" id="pesoTotal">0</div>
              <div class="stat-label">Peso Total (kg)</div>
            </div>
            <div class="stat-item">
              <div class="stat-value">S/ <span id="valorTotal">0.00</span></div>
              <div class="stat-label">Valor Total</div>
            </div>
          </div>
        </div>

        <div id="tableContent">
          <div class="empty-state">
            <p>No hay env√≠os registrados a√∫n</p>
            <p>Comienza agregando tu primer env√≠o</p>
          </div>
        </div>

        <div class="table-actions">
          <button type="button" class="btn-limpiar-todos" onclick="limpiarTodosEnvios()" title="Eliminar todos los env√≠os">üóëÔ∏è Eliminar todo</button>
          <button type="button" class="btn-exportar" onclick="exportarCSV()">üì• Exportar CSV</button>
        </div>
      </div>
    </div>



    <!-- Bot√≥n continuar -->
    <button type="button" class="btn-continuar" id="btn-continuar">CONTINUAR</button>
  </form>
</div>





<!-- Modal de Confirmaci√≥n -->
<div id="modalConfirmacion" class="modal-confirm" style="display: none;">
  <div class="modal-content">
    <p>¬øDeseas agregar este env√≠o?</p>
    <div class="modal-buttons">
      <button class="btn_cancel" onclick="cerrarModal()">Cancelar</button>
      <button class="btn_acept" id="confirmarBtn">S√≠, agregar</button>
    </div>
  </div>
</div>


<style>
.modal-confirm {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0,0,0,0.4);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 1000;
}
.modal-content {
  background: white;
  padding: 25px;
  border-radius: 8px;
  text-align: center;
  width: 300px;
}
.modal-buttons {
  margin-top: 15px;
  display: flex;
  justify-content: space-around;
}

.modal-buttons button {
  padding-block: 5px;
  padding-inline: 10px;
}
</style>

  <!-- Modal de Seguro -->
    <div id="modalSeguro" class="modal-seguro">
        <div class="modal-seguro-content">
            <div class="modal-seguro-header">
                <h3>‚ö†Ô∏è Seguro Obligatorio</h3>
            </div>
            
            <div class="modal-seguro-body">
                <div class="alerta-valor">
                    <div class="alerta-valor-monto" id="valorDeclarado">S/ 150.00</div>
                    <div class="alerta-valor-texto">El valor declarado excede los S/ 100.00</div>
                </div>

                <div class="porcentaje-seguro">
                    <div class="porcentaje-valor" id="porcentajeSeguro">2%</div>
                    <div class="porcentaje-label">Se aplicar√° porcentaje de seguro</div>
                </div>

                <ul class="condiciones-lista">
                    <li>
                        <div>
                            <strong>Seguro obligatorio:</strong> Para env√≠os con valor declarado superior a S/ 100.00, se aplicar√° autom√°ticamente un seguro del 2% sobre el valor total.
                        </div>
                    </li>
                    <li>
                        <div>
                            <strong>Cobertura:</strong> El seguro cubre p√©rdida total o da√±os del paquete durante el transporte hasta el monto declarado.
                        </div>
                    </li>
                    <li>
                        <div>
                            <strong>Responsabilidad:</strong> El valor declarado debe ser real y verificable. Declaraciones falsas pueden anular la cobertura.
                        </div>
                    </li>
                    <li>
                        <div>
                            <strong>Proceso de reclamo:</strong> En caso de siniestro, deber√° presentar documentaci√≥n que respalde el valor declarado.
                        </div>
                    </li>
                    <li>
                        <div>
                            <strong>Tiempo de reclamo:</strong> Los reclamos deben reportarse dentro de las 48 horas posteriores a la entrega programada.
                        </div>
                    </li>
                </ul>

                <div style="background: #f7fafc; padding: 1rem; border-radius: 8px; border-left: 4px solid #48bb78;">
                    <strong>Costo del seguro:</strong> S/ <span id="costoSeguroModal">3.00</span>
                    <br>
                    <small style="color: #718096;">Este monto se agregar√° autom√°ticamente al costo total del env√≠o</small>
                </div>

                <div class="modal-seguro-buttons">
                    <button class="btn-modal btn-modal-cancelar" onclick="cerrarModalSeguro()">
                        Cancelar
                    </button>
                    <button class="btn-modal btn-modal-aceptar" onclick="aceptarSeguroYAgregar()">
                        Acepto y contin√∫o
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Detalle de Tarifa -->
    <div id="modalDetalleTarifa" class="modal-detalle-tarifa">
        <div class="modal-detalle-content">
            <div class="modal-detalle-header">
                <h3>üí∞ ¬øPor qu√© este precio?</h3>
            </div>
            
            <div class="modal-detalle-body">
                <div class="detalle-explicacion">
                    <h4>üìä Desglose detallado de la tarifa</h4>
                    
                    <div class="detalle-item-explicacion">
                        <div class="detalle-item-titulo">
                            <span>Tarifa Base</span>
                            <span class="detalle-item-monto" id="modal-tarifa-base">S/ 18.00</span>
                        </div>
                        <div class="detalle-item-descripcion">
                            Costo est√°ndar por el servicio de transporte entre las ciudades seleccionadas. Esta tarifa se calcula en base a la distancia y zona de cobertura.
                        </div>
                    </div>

                    <div class="detalle-item-explicacion" id="explicacion-peso">
                        <div class="detalle-item-titulo">
                            <span>Costo Adicional por Peso</span>
                            <span class="detalle-item-monto" id="modal-costo-peso">S/ 4.00</span>
                        </div>
                        <div class="detalle-item-descripcion">
                            Su paquete excede el peso base incluido (1 kg). Se aplica un costo adicional por cada kilogramo extra.
                            <div class="detalle-porcentaje">
                                <span class="detalle-porcentaje-texto" id="detalle-peso-info">Peso adicional: 2 kg √ó S/ 2.00 = S/ 4.00</span>
                            </div>
                        </div>
                    </div>

                    <div class="detalle-item-explicacion" id="explicacion-valor" style="display: none;">
                        <div class="detalle-item-titulo">
                            <span>Costo Adicional por Valor Asegurado</span>
                            <span class="detalle-item-monto" id="modal-costo-valor">S/ 0.00</span>
                        </div>
                        <div class="detalle-item-descripcion">
                            Para paquetes con valor declarado superior a S/ 100.00, se aplica un seguro obligatorio para proteger su env√≠o.
                            <div class="detalle-porcentaje">
                                <span class="detalle-porcentaje-texto" id="detalle-valor-info">2% del valor declarado</span>
                            </div>
                        </div>
                    </div>

                    <div class="detalle-item-explicacion" id="explicacion-domicilio" style="display: none;">
                        <div class="detalle-item-titulo">
                            <span>Costo Adicional por Entrega a Domicilio</span>
                            <span class="detalle-item-monto" id="modal-costo-domicilio">S/ 0.00</span>
                        </div>
                        <div class="detalle-item-descripcion">
                            Servicio de entrega a domicilio que incluye la llegada de nuestro personal hasta la direcci√≥n espec√≠fica del destinatario.
                            <div class="detalle-porcentaje">
                                <span class="detalle-porcentaje-texto">Incremento del 25% sobre la tarifa base</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div style="background: #f0f4f8; padding: 1.5rem; border-radius: 8px; border-left: 4px solid #667eea;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                        <strong style="color: #2d3748; font-size: 1.1rem;">Total Final:</strong>
                        <strong style="color: #667eea; font-size: 1.3rem;" id="modal-total-final">S/ 22.00</strong>
                    </div>
                    <small style="color: #718096;">
                        * Los precios pueden variar seg√∫n las dimensiones exactas al momento del pesaje
                    </small>
                </div>
            </div>

            <div class="modal-detalle-footer">
                <button class="btn-cerrar-detalle" onclick="cerrarModalDetalleTarifa()">
                    Entendido
                </button>
            </div>
        </div>
    </div>

{% endblock %}

{% block scripts %}

<script>
function mostrarModalConfirmacion() {
  document.getElementById('modalConfirmacion').style.display = 'flex';

  // Aseguramos que no se acumulen m√∫ltiples listeners
  const confirmarBtn = document.getElementById('confirmarBtn');
  confirmarBtn.replaceWith(confirmarBtn.cloneNode(true)); // Reset listener
  document.getElementById('confirmarBtn').addEventListener('click', () => {
    cerrarModal();
    agregarEnvio(); // Solo se llama si confirma
  });
}

function cerrarModal() {
  document.getElementById('modalConfirmacion').style.display = 'none';
}
</script>

<script>
  window.CONFIG_ENVIO = {
    tiposDocumento: {{ nombre_doc | tojson }},
    tiposRecepcion: {{ nombre_rep | tojson }},
    tiposEmpaque: {{ empaque | tojson }},
    rutasTarifas: {{ sucursales | safe }},
    articulos : {{articulos | tojson}}
  };
</script>
<script src="{{ url_for('static', filename='js/envio_masivo.js') }}"></script>


{% endblock %}