{% extends "MAESTRA_ADMIN.html" %}

{% block estilos %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<style>
#map {
  height: 400px;
  width: 100%;
  border-radius: 10px;
  margin-top: 10px;
}

.leaflet-popup-content .btn-agregar-escala {
    display: inline-block;
    background-color: #28a745;
    color: white;
    padding: 4px 10px;
    font-size: 0.8rem;
    border: none;
    border-radius: 5px;
    margin-top: 6px;
    cursor: pointer;
}

.leaflet-popup-content .btn-eliminar-escala {
    display: inline-block;
    background-color: #dc3545;
    color: white;
    padding: 4px 10px;
    font-size: 0.8rem;
    border: none;
    border-radius: 5px;
    margin-top: 6px;
    cursor: pointer;
    margin-left: 5px;
}

/* Estilos para marcadores numerados */
.marker-numero {
    background-color: #007bff;
    color: white;
    border-radius: 50%;
    width: 30px;
    height: 30px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    font-size: 14px;
    border: 2px solid white;
    box-shadow: 0 2px 6px rgba(0,0,0,0.3);
}

.marker-escala {
    background-color: #28a745;
}

.marker-origen {
    background-color: #ff6b6b;
}

.marker-destino {
    background-color: #4ecdc4;
}

/* Estilos para las escalas */
.escala-item {
    display: flex;
    align-items: center;
    padding: 10px;
    border: 1px solid #ddd;
    border-radius: 8px;
    margin-bottom: 8px;
    background: white;
    cursor: pointer;
    transition: all 0.3s ease;
}

.escala-item:hover {
    background: #f8f9fa;
    border-color: #007bff;
}

.escala-number {
    background: #007bff;
    color: white;
    border-radius: 50%;
    width: 30px;
    height: 30px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    margin-right: 15px;
    flex-shrink: 0;
}

.escalas-info {
    background: #e3f2fd;
    padding: 10px;
    border-radius: 8px;
    margin-bottom: 15px;
    font-size: 0.9rem;
    color: #1976d2;
}

.escalas-controles {
    display: flex;
    gap: 10px;
    margin-bottom: 15px;
    flex-wrap: wrap;
}

.escalas-controles button {
    padding: 8px 15px;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    font-size: 0.9rem;
    transition: all 0.3s ease;
}

.btn-limpiar {
    background-color: #6c757d;
    color: white;
}

.btn-limpiar:hover {
    background-color: #5a6268;
}

.btn-optimizar {
    background-color: #17a2b8;
    color: white;
}

.btn-secondary {
    background-color: #6c757d;
    color: white;
}

.btn-secondary:hover {
    background-color: #5a6268;
}

/* Estilos para pesta√±as deshabilitadas */
.tabs-container.disabled {
    opacity: 0.5;
    pointer-events: none;
}

.form-disabled {
    opacity: 0.6;
    pointer-events: none;
}

.alert-info {
    background-color: #d1ecf1;
    border-color: #bee5eb;
    color: #0c5460;
    padding: 10px;
    border-radius: 5px;
    margin-bottom: 15px;
}
</style>
<link rel="stylesheet" href="/static/css/salida_informacion.css">

{% endblock estilos %}

{% block titulo %}
Programar nueva salida
{% endblock %}

{% block contenido %}

  <div class="container">
        <!-- Header -->
    <div class="block_crud block_title" style="padding: 20px 10px 30px 10px; font-size: 1rem;">
  <h3 class="crud_title">
    <i class="{{page_icono}}"></i> 
    {{page_titulo}}
  </h3>
</div>

        <!-- Resumen Superior -->
        <div class="summary-container">
            <h2 class="summary-title">
                <i class="fa-solid fa-chart-line"></i>
                Programaci√≥n de la Salida
            </h2>

            <!-- Datos Generales aqu√≠ -->
            <div class="general-data-section">
                <h3 class="general-title">
                    <i class="fa-solid fa-calendar-days"></i>
                    Datos Generales
                </h3>
                <div class="form-group">
                    <div class="form-field">
                        <label for="fecha">Fecha de salida:</label>
                        <input type="date" id="fecha" required onchange="validarDatosGenerales()">
                    </div>
                    <div class="form-field">
                        <label for="hora">Hora de salida:</label>
                        <input type="time" id="hora" required onchange="validarDatosGenerales()">
                    </div>

                    
                    <div class="form-field">
                        <label for="origenSelect">Seleccionar destino de origen:</label>
                        <select id="origenSelect" required onchange="cargarDestinos(this.value)">
                            <option value="">-- Seleccione el destino de origen --</option>
                              {% for fila in sucursal_origen %}
                            <option value="{{fila.sucursal_origen_id}}" 
                                    data-lat="{{fila.latitud}}" 
                                    data-lng="{{fila.longitud}}">{{fila.nombre}}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="form-field">
                        <label for="destinoSelect">Seleccionar destino final:</label>
                        <select id="destinoSelect" required disabled onchange="validarDatosGenerales()">
                            <option value="">-- Primero seleccione un origen --</option>
                        </select>
                    </div>

                </div>
                
                <div class="alert alert-info" id="alertaDatosGenerales">
                    <i class="fa-solid fa-info-circle"></i>
                    Complete todos los datos generales para habilitar la configuraci√≥n de la salida.
                </div>
            </div>
        </div>

        <!-- Sistema de Pesta√±as -->
        <div class="tabs-container disabled" id="tabsContainer">
            <div class="tabs-nav">
                <button class="tab-btn active" onclick="openTab(event, 'tab-vehiculo')">
                    <i class="fa-solid fa-truck"></i>
                    Unidad
                </button>
                <button class="tab-btn" onclick="openTab(event, 'tab-empleados')">
                    <i class="fa-solid fa-users"></i>
                    Empleados
                </button>
                <button class="tab-btn" onclick="openTab(event, 'tab-escalas')">
                    <i class="fa-solid fa-route"></i>
                    Escalas
                </button>
                <button class="tab-btn" onclick="openTab(event, 'tab-paquetes')">
                    <i class="fa-solid fa-boxes-stacked"></i>
                    Paquetes
                </button>
                <button class="tab-btn" onclick="openTab(event, 'tab-recojos')">
                    <i class="fa-solid fa-house"></i>
                    Recojos
                </button>
            </div>

            <!-- Contenido Pesta√±a: Veh√≠culo -->
            <div id="tab-vehiculo" class="tab-content active">
                <div class="section">
                    <h2 class="section-title">üöö Selecci√≥n de unidad</h2>
                    <div class="alert alert-error" id="errorVehiculo"></div>
                    
                    <table id="vehiculosTabla">
                        <thead>
                            <tr>
                                <th>Veh√≠culo</th>
                                <th>Capacidad M√°xima (kg)</th>
                                <th>Capacidad Usada (kg)</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>

                    <div class="assigned-items" id="vehiculoSeleccionado" style="display: none;">
                        <h4>üöö Veh√≠culo seleccionado:</h4>
                        <div id="vehiculoInfo"></div>
                        <div class="capacity-bar" style="margin-top: 10px;">
                            <div id="capacityFill" class="capacity-fill" style="width: 0%"></div>
                        </div>
                        <div id="capacityText" style="margin-top: 5px; font-size: 0.9rem; color: #666;">0 kg / 0 kg (0%)</div>
                    </div>
                </div>
            </div>

            <!-- Contenido Pesta√±a: Empleados -->
            <div id="tab-empleados" class="tab-content">
                <div class="section">
                    <h2 class="section-title">üë• Gesti√≥n de Empleados</h2>
                    
                    <table id="empleadosTabla">
                        <thead>
                            <tr>
                                <th>Empleado</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>

                    <div class="assigned-items">
                        <h4>üë• Empleados Asignados:</h4>
                        <div id="empleadosAsignados">
                            <span style="color: #666; font-style: italic;">No hay empleados asignados</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Contenido Pesta√±a: Paquetes -->
            <div id="tab-paquetes" class="tab-content">
                <div class="section">
                    <h2 class="section-title">üì¶ Gesti√≥n de Paquetes</h2>
                    <div class="alert alert-error" id="errorPaquetes"></div>
                    
                    <div class="alert alert-info" id="infoPaquetes">
                        <i class="fa-solid fa-info-circle"></i>
                        Los paquetes se cargar√°n autom√°ticamente seg√∫n el origen y destino seleccionados.
                    </div>
                    
                    <table id="paquetesTabla">
                        <thead>
                            <tr>
                                <th>Tracking</th>
                                <th>Descripci√≥n</th>
                                <th>Peso (kg)</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>

                    <div class="assigned-items">
                        <h4>üì¶ Paquetes Asignados:</h4>
                        <div id="paquetesAsignados">
                            <span style="color: #666; font-style: italic;">No hay paquetes asignados</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Contenido Pesta√±a: Escalas -->
            <div id="tab-escalas" class="tab-content">
                <div class="section">
                    <h2 class="section-title">üó∫Ô∏è Escalas de ruta</h2>

                    <div class="escalas-container">
                        <h4>üìç Escalas programadas (<span id="contadorEscalas">0</span>/5):</h4>
                        <div id="escalasLista">
                            <span style="color: #666; font-style: italic;">No hay escalas programadas</span>
                        </div>
                    </div>

                    <div class="mapa-container col">
                        <div id="map" class="mt-3" style="height: 400px;">

                        </div>
                    </div>

                </div>
            </div>

            <!-- Contenido Pesta√±a: Recojos -->
            <div id="tab-recojos" class="tab-content">
                <div class="section">
                    <h2 class="section-title">üè† Recojos en casa</h2>
                    <div class="checkbox-group">
                        <input type="checkbox" id="recojoCheckbox" onchange="toggleRecojoSection()">
                        <label for="recojoCheckbox">¬øIncluir recojos en casa?</label>
                    </div>
                    
                    <div class="recojo-section" id="recojoSection">
                        <h4 style="color: #f39c12; margin-bottom: 15px;">üìã Transacciones disponibles para recojo:</h4>
                        <div id="transaccionesRecojo">
                            <!-- Las transacciones se cargan aqu√≠ din√°micamente -->
                        </div>
                        
                        <div class="assigned-items" style="margin-top: 20px;">
                            <h4>üè† Recojos seleccionados:</h4>
                            <div id="recojosAsignados">
                                <span style="color: #666; font-style: italic;">No hay recojos seleccionados</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Bot√≥n Guardar -->
        <div class="save-section">
            <button class="btn btn-success" onclick="guardarSalida()" disabled id="btnGuardar">
                Guardar salida
            </button>
            <div class="alert" id="mensajeGuardado" style="margin-top: 15px;"></div>
        </div>
    </div>
{% endblock contenido %}


{% block scripts %}
  <script>
 const vehiculos = {{ unidades | tojson }};
 const sucursalesOrigen = {{ sucursal_origen | tojson }};
 const empleados = {{ empleados | tojson }};
 const agencias = {{ agencias | tojson }};
 const paquetes = {{ paquetes | tojson }}

// Variables globales
let escalas = [];
let map;
let rutaLayer = null;
let agenciaMarkers = [];
let escalasMarkers = [];
let origenMarker = null;
let destinoMarker = null;
const MAX_ESCALAS = 5;

// Variables para almacenar datos seleccionados
let origenSeleccionado = null;
let destinoSeleccionado = null;
let destinosDisponibles = [];

// Funci√≥n para inicializar el mapa
function inicializarMapa() {
    if (map) return; // Ya est√° inicializado
    
    map = L.map('map').setView([-6.77, -79.84], 6);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);
}



// Datos de transacciones de recojo en casa
const transaccionesRecojo = [
    { 
        id: 1, 
        numeroTransaccion: "RC-2024-001", 
        direccion: "Av. Los Jardines 245, Urb. San Mart√≠n", 
        cliente: "Mar√≠a Gonz√°lez Ruiz",
        telefono: "987654321",
        estado: "Pendiente"
    },
    { 
        id: 2, 
        numeroTransaccion: "RC-2024-002", 
        direccion: "Jr. Las Flores 678, Pueblo Libre", 
        cliente: "Carlos Mendoza Silva",
        telefono: "976543210",
        estado: "Pendiente"
    },
    { 
        id: 3, 
        numeroTransaccion: "RC-2024-003", 
        direccion: "Calle Los Pinos 123, San Isidro", 
        cliente: "Ana Torres Vega",
        telefono: "965432109",
        estado: "Pendiente"
    },
    { 
        id: 4, 
        numeroTransaccion: "RC-2024-004", 
        direccion: "Av. Industrial 987, Callao", 
        cliente: "Roberto Silva Morales",
        telefono: "954321098",
        estado: "Pendiente"
    },
    { 
        id: 5, 
        numeroTransaccion: "RC-2024-005", 
        direccion: "Jr. Comercio 456, Miraflores", 
        cliente: "Luc√≠a Vargas Castro",
        telefono: "943210987",
        estado: "Pendiente"
    },
    { 
        id: 6, 
        numeroTransaccion: "RC-2024-006", 
        direccion: "Av. Universitaria 741, Los Olivos", 
        cliente: "Pedro Ram√≠rez L√≥pez",
        telefono: "932109876",
        estado: "Pendiente"
    },
    { 
        id: 7, 
        numeroTransaccion: "RC-2024-007", 
        direccion: "Jr. Ayacucho 852, Bre√±a", 
        cliente: "Carmen Delgado Ramos",
        telefono: "921098765",
        estado: "Pendiente"
    },
    { 
        id: 8, 
        numeroTransaccion: "RC-2024-008", 
        direccion: "Av. El Sol 963, San Juan de Miraflores", 
        cliente: "Jos√© Hern√°ndez Paz",
        telefono: "910987654",
        estado: "Pendiente"
    }
];

// Variables de estado
let vehiculoSeleccionado = null;
let empleadosAsignados = [];
let paquetesAsignados = [];
let recojosAsignados = [];
let pesoTotal = 0;

// Funci√≥n para cargar destinos seg√∫n origen seleccionado
async function cargarDestinos(sucursal_origen_id) {
    try {
        if (!sucursal_origen_id) {
            const destinoSelect = document.getElementById('destinoSelect');
            destinoSelect.innerHTML = '<option value="">-- Primero seleccione un origen --</option>';
            destinoSelect.disabled = true;
            return;
        }

        const response = await fetch('/sucursales_destino_api', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ sucursal_origen_id: sucursal_origen_id })
        });

        const data = await response.json();
        
        if (data.status === 1) {
            destinosDisponibles = data.data;
            updateSelect('destinoSelect', data.data, 'nombre', '-- Seleccione el destino final --', 'sucursal_destino_id');
            document.getElementById('destinoSelect').disabled = false;
            
            // Guardar datos del origen seleccionado
            const origenSelect = document.getElementById('origenSelect');
            const selectedOption = origenSelect.options[origenSelect.selectedIndex];
            origenSeleccionado = {
                id: sucursal_origen_id,
                nombre: selectedOption.text,
                lat: parseFloat(selectedOption.dataset.lat),
                lng: parseFloat(selectedOption.dataset.lng)
            };
            
            console.log('Origen seleccionado:', origenSeleccionado);
            
        } else {
            showAlert('mensajeGuardado', 'Error al cargar destinos: ' + data.msg, 'error');
        }
    } catch (error) {
        console.error('Error cargando destinos:', error);
        showAlert('mensajeGuardado', 'Error de conexi√≥n al cargar destinos', 'error');
    }
}

// Funci√≥n para actualizar un select
function updateSelect(selectId, data, textField, placeholder, valueField = null) {
    const select = document.getElementById(selectId);
    if (!select) return;

    select.innerHTML = `<option value="">${placeholder}</option>`;

    if (data && Array.isArray(data)) {
        data.forEach(item => {
            const value = valueField ? item[valueField] : item[textField];
            const text = item[textField];
            const option = new Option(text, value);
            
            // Agregar data attributes para latitud y longitud si est√°n disponibles
            if (item.latitud && item.longitud) {
                option.dataset.lat = item.latitud;
                option.dataset.lng = item.longitud;
            }
            
            select.appendChild(option);
        });
    }
}

// Funci√≥n para validar datos generales y habilitar pesta√±as
function validarDatosGenerales() {
    const fecha = document.getElementById('fecha').value;
    const hora = document.getElementById('hora').value;
    const origen = document.getElementById('origenSelect').value;
    const destino = document.getElementById('destinoSelect').value;
    
    const tabsContainer = document.getElementById('tabsContainer');
    const alertaDatos = document.getElementById('alertaDatosGenerales');
    const btnGuardar = document.getElementById('btnGuardar');
    
    // Contar campos completados
    const camposCompletos = [fecha, hora, origen, destino].filter(campo => campo).length;
    const totalCampos = 4;
    
    // Actualizar mensaje de alerta con progreso
    if (camposCompletos === totalCampos) {
        // Todos los datos est√°n completos
        tabsContainer.classList.remove('disabled');
        alertaDatos.style.display = 'none';
        btnGuardar.disabled = false;
        
        // Guardar datos del destino seleccionado
        const destinoSelect = document.getElementById('destinoSelect');
        const selectedDestino = destinoSelect.options[destinoSelect.selectedIndex];
        
        if (selectedDestino.dataset.lat && selectedDestino.dataset.lng) {
            destinoSeleccionado = {
                id: destino,
                nombre: selectedDestino.text,
                lat: parseFloat(selectedDestino.dataset.lat),
                lng: parseFloat(selectedDestino.dataset.lng)
            };
        } else {
            // Buscar en destinosDisponibles
            const destinoData = destinosDisponibles.find(d => d.sucursal_destino_id == destino);
            if (destinoData) {
                destinoSeleccionado = {
                    id: destino,
                    nombre: destinoData.nombre,
                    lat: parseFloat(destinoData.latitud),
                    lng: parseFloat(destinoData.longitud)
                };
            }
        }
        
        console.log('Destino seleccionado:', destinoSeleccionado);
        
        // Cargar paquetes para esta ruta
        cargarPaquetesParaRuta();
        
        // Actualizar mapa con origen y destino
        if (map) {
            actualizarMapaConRutaPrincipal();
        }
        
    } else {
        // Faltan datos - mostrar progreso
        tabsContainer.classList.add('disabled');
        alertaDatos.style.display = 'block';
        btnGuardar.disabled = true;
        
        // Mensaje din√°mico seg√∫n el progreso
        let mensaje = `Complete todos los datos generales para continuar (${camposCompletos}/${totalCampos}): `;
        const faltantes = [];
        
        if (!fecha) faltantes.push('Fecha de salida');
        if (!hora) faltantes.push('Hora de salida');
        if (!origen) faltantes.push('Origen');
        if (!destino) faltantes.push('Destino final');
        
        mensaje += faltantes.join(', ');
        
        alertaDatos.innerHTML = `
            <i class="fa-solid fa-info-circle"></i>
            ${mensaje}
            <div style="background: #fff; border-radius: 10px; margin-top: 8px; overflow: hidden;">
                <div style="background: #28a745; height: 4px; width: ${(camposCompletos/totalCampos)*100}%; transition: width 0.3s ease;"></div>
            </div>
        `;
    }
}

// Funci√≥n para cargar paquetes seg√∫n la ruta seleccionada
function obtenerPaquetesParaRuta() {
    // Verificar que tenemos origen y destino
    if (!origenSeleccionado || !destinoSeleccionado) {
        console.log('‚ö†Ô∏è No hay origen o destino seleccionado');
        return [];
    }
    
    // Crear ruta completa: [origen, escalas..., destino]
    const rutaCompleta = [
        { id: parseInt(origenSeleccionado.id), nombre: origenSeleccionado.nombre },
        ...escalas.map(escala => ({ id: escala.id, nombre: escala.nombre })),
        { id: parseInt(destinoSeleccionado.id), nombre: destinoSeleccionado.nombre }
    ];
    
    console.log('üó∫Ô∏è Ruta completa:', rutaCompleta.map(r => r.nombre).join(' ‚Üí '));
    
    // Extraer solo los IDs para facilitar b√∫squedas
    const idsRuta = rutaCompleta.map(punto => punto.id);
    
    console.log('üìç IDs en la ruta:', idsRuta);
    
    // Filtrar paquetes que pueden viajar en esta ruta
    const paquetesValidos = paquetes.filter(paquete => {
        const origenPaquete = parseInt(paquete.id_sucursal_origen);
        const destinoPaquete = parseInt(paquete.sucursal_destino_id);
        
        // El origen del paquete debe estar en nuestra ruta
        const origenEnRuta = idsRuta.includes(origenPaquete);
        
        // El destino del paquete debe estar en nuestra ruta
        const destinoEnRuta = idsRuta.includes(destinoPaquete);
        
        // El origen debe ser diferente al destino
        const origenDistintoDestino = origenPaquete !== destinoPaquete;
        
        // Verificar que el orden sea correcto (origen antes que destino en la ruta)
        const indiceOrigen = idsRuta.indexOf(origenPaquete);
        const indiceDestino = idsRuta.indexOf(destinoPaquete);
        const ordenCorrecto = indiceOrigen !== -1 && indiceDestino !== -1 && indiceOrigen < indiceDestino;
        
        return origenEnRuta && destinoEnRuta && origenDistintoDestino && ordenCorrecto;
    });
    
    console.log(`üì¶ Paquetes v√°lidos encontrados: ${paquetesValidos.length}`);
    
    // Categorizar y enriquecer cada paquete
    const paquetesCategorizados = paquetesValidos.map(paquete => {
        const origenPaquete = parseInt(paquete.id_sucursal_origen);
        const destinoPaquete = parseInt(paquete.sucursal_destino_id);
        
        const indiceCarga = idsRuta.indexOf(origenPaquete);
        const indiceDescarga = idsRuta.indexOf(destinoPaquete);
        
        // Determinar tipo de paquete
        let tipo = 'entre_escalas';
        let descripcionRuta = '';
        let iconoTipo = 'üì¶';
        
        const puntoOrigen = rutaCompleta[indiceCarga]?.nombre.split(' / ')[0] || 'Origen';
        const puntoDestino = rutaCompleta[indiceDescarga]?.nombre.split(' / ')[0] || 'Destino';
        
        if (indiceCarga === 0 && indiceDescarga === rutaCompleta.length - 1) {
            // Viaje completo: del primer punto al √∫ltimo
            tipo = 'largo_recorrido';
            iconoTipo = 'üöÄ';
            descripcionRuta = `${puntoOrigen} ‚Üí ${puntoDestino} (Viaje completo)`;
        } else if (indiceCarga === 0) {
            // Se carga en origen, se entrega en una escala
            tipo = 'entrega_intermedia';
            iconoTipo = 'üì§';
            descripcionRuta = `${puntoOrigen} ‚Üí ${puntoDestino} (Entrega en escala)`;
        } else if (indiceDescarga === rutaCompleta.length - 1) {
            // Se recoge en una escala, se entrega en destino final
            tipo = 'recojo_intermedio';
            iconoTipo = 'üì•';
            descripcionRuta = `${puntoOrigen} ‚Üí ${puntoDestino} (Recojo en escala)`;
        } else {
            // Entre escalas intermedias
            tipo = 'entre_escalas';
            iconoTipo = 'üîÑ';
            descripcionRuta = `${puntoOrigen} ‚Üí ${puntoDestino} (Entre escalas)`;
        }
        
        return {
            id: paquete.tracking,              // ‚úÖ Usar tracking como ID √∫nico
            tracking: paquete.tracking,        // ‚úÖ Campo tracking
            descripcion: descripcionRuta,      // ‚úÖ Descripci√≥n generada
            peso: parseFloat(paquete.peso),    // ‚úÖ Peso como n√∫mero
            punto_carga: indiceCarga,          // ‚úÖ √çndice donde se carga
            punto_descarga: indiceDescarga,    // ‚úÖ √çndice donde se descarga
            tipo: tipo,                        // ‚úÖ Tipo de env√≠o
            origen_id: origenPaquete,          // ‚úÖ ID de sucursal origen
            destino_id: destinoPaquete,        // ‚úÖ ID de sucursal destino
            icono: iconoTipo                   // ‚úÖ Icono para la UI
        };
    });
    
    // Estad√≠sticas para debug
    const estadisticas = paquetesCategorizados.reduce((acc, paquete) => {
        acc[paquete.tipo] = (acc[paquete.tipo] || 0) + 1;
        return acc;
    }, {});
    
    console.log('üìä Estad√≠sticas de paquetes:', estadisticas);
    
    return paquetesCategorizados;
}


function crearIndicePaquetes() {
    if (!paquetes || !Array.isArray(paquetes)) return {};
    
    const indice = {
        porOrigen: {},
        porDestino: {},
        porRuta: {}
    };
    
    paquetes.forEach(paquete => {
        const origen = parseInt(paquete.id_sucursal_origen);
        const destino = parseInt(paquete.sucursal_destino_id);
        
        // √çndice por origen
        if (!indice.porOrigen[origen]) indice.porOrigen[origen] = [];
        indice.porOrigen[origen].push(paquete);
        
        // √çndice por destino
        if (!indice.porDestino[destino]) indice.porDestino[destino] = [];
        indice.porDestino[destino].push(paquete);
        
        // √çndice por ruta (origen-destino)
        const claveRuta = `${origen}-${destino}`;
        if (!indice.porRuta[claveRuta]) indice.porRuta[claveRuta] = [];
        indice.porRuta[claveRuta].push(paquete);
    });
    
    return indice;
}


// Funci√≥n para actualizar mapa con ruta principal
function actualizarMapaConRutaPrincipal() {
    if (!map || !origenSeleccionado || !destinoSeleccionado) return;
    
    // Limpiar marcadores de origen y destino anteriores
    if (origenMarker) {
        map.removeLayer(origenMarker);
    }
    if (destinoMarker) {
        map.removeLayer(destinoMarker);
    }
    
    // Crear marcador de origen
    origenMarker = L.marker([origenSeleccionado.lat, origenSeleccionado.lng], {
        icon: L.divIcon({
            className: 'marker-numero marker-origen',
            html: `<div class="marker-numero marker-origen">O</div>`,
            iconSize: [30, 30],
            iconAnchor: [15, 15]
        })
    }).addTo(map);
    
    origenMarker.bindPopup(`
        <strong>üöÄ ORIGEN</strong><br>
        ${origenSeleccionado.nombre}
    `);
    
    // Crear marcador de destino
    destinoMarker = L.marker([destinoSeleccionado.lat, destinoSeleccionado.lng], {
        icon: L.divIcon({
            className: 'marker-numero marker-destino',
            html: `<div class="marker-numero marker-destino">D</div>`,
            iconSize: [30, 30],
            iconAnchor: [15, 15]
        })
    }).addTo(map);
    
    destinoMarker.bindPopup(`
        <strong>üéØ DESTINO FINAL</strong><br>
        ${destinoSeleccionado.nombre}
    `);
    
    // Actualizar vista del mapa para incluir origen y destino
    actualizarRutaEnMapa();
}

// Funci√≥n para cambiar pesta√±as
function openTab(evt, tabName) {
    var i, tabcontent, tablinks;
    
    // Ocultar todo el contenido de pesta√±as
    tabcontent = document.getElementsByClassName("tab-content");
    for (i = 0; i < tabcontent.length; i++) {
        tabcontent[i].classList.remove("active");
    }
    
    // Remover la clase activa de todos los botones de pesta√±as
    tablinks = document.getElementsByClassName("tab-btn");
    for (i = 0; i < tablinks.length; i++) {
        tablinks[i].classList.remove("active");
    }
    
    // Mostrar la pesta√±a actual y marcar el bot√≥n como activo
    document.getElementById(tabName).classList.add("active");
    evt.currentTarget.classList.add("active");

    // Inicializar mapa cuando se abre la pesta√±a de escalas
    if (tabName === 'tab-escalas') {
        setTimeout(() => {
            inicializarMapa();
            if (map) {
                map.invalidateSize();
                mostrarAgenciasEnMapa();
                actualizarMapaConRutaPrincipal();
                actualizarRutaEnMapa();
            }
        }, 100);
    }
}

// Inicializar la aplicaci√≥n
document.addEventListener('DOMContentLoaded', function() {
    configurarFechaHoraMinimas();
    
    renderizarVehiculos();
    renderizarEmpleados();
    renderizarPaquetes();
    cargarTransaccionesRecojo();
    actualizarContadorEscalas();
    
    // Inicializar variable global para paquetes
    window.paquetesDisponibles = [];
     setTimeout(() => {
        verificarDatosPaquetes();
    }, 1000);

    window.indicePaquetes = crearIndicePaquetes();
    
    console.log('üìä √çndice de paquetes creado:', {
        origenes: Object.keys(window.indicePaquetes.porOrigen).length,
        destinos: Object.keys(window.indicePaquetes.porDestino).length,
        rutas: Object.keys(window.indicePaquetes.porRuta).length
    });

});



// Funci√≥n para configurar fecha y hora m√≠nimas
function configurarFechaHoraMinimas() {
    const ahora = new Date();
    const fechaInput = document.getElementById('fecha');
    const horaInput = document.getElementById('hora');
    
    // Configurar fecha m√≠nima (hoy)
    const fechaHoy = ahora.toISOString().split('T')[0];
    fechaInput.min = fechaHoy;
    fechaInput.value = fechaHoy;
    
    // Configurar hora m√≠nima si es hoy
    const horaActual = ahora.toTimeString().split(' ')[0].substring(0, 5);
    horaInput.value = horaActual;
    
    // Event listener para validar fecha
    fechaInput.addEventListener('change', function() {
        validarFechaHora();
    });
    
    // Event listener para validar hora
    horaInput.addEventListener('change', function() {
        validarFechaHora();
    });
    
    // Validaci√≥n inicial
    validarFechaHora();
}

// Funci√≥n para validar fecha y hora
function validarFechaHora() {
    const fechaInput = document.getElementById('fecha');
    const horaInput = document.getElementById('hora');
    const ahora = new Date();
    
    const fechaSeleccionada = new Date(fechaInput.value);
    const fechaHoy = new Date();
    fechaHoy.setHours(0, 0, 0, 0); // Resetear hora para comparar solo fechas
    
    // Si la fecha seleccionada es hoy
    if (fechaSeleccionada.getTime() === fechaHoy.getTime()) {
        // Configurar hora m√≠nima como la actual + 30 minutos
        const horaMinima = new Date();
        horaMinima.setMinutes(horaMinima.getMinutes() + 30);
        const horaMinStr = horaMinima.toTimeString().split(' ')[0].substring(0, 5);
        
        horaInput.min = horaMinStr;
        
        // Si la hora actual es menor que la m√≠nima, ajustarla
        if (horaInput.value < horaMinStr) {
            horaInput.value = horaMinStr;
            showAlert('mensajeGuardado', 'La hora de salida debe ser al menos 30 minutos despu√©s de la hora actual', 'warning');
        }
    } else {
        // Si es una fecha futura, no hay restricci√≥n de hora
        horaInput.min = '00:00';
    }
    
    // Validar que la fecha no sea pasada
    if (fechaSeleccionada < fechaHoy) {
        fechaInput.value = fechaHoy.toISOString().split('T')[0];
        showAlert('mensajeGuardado', 'No se puede seleccionar una fecha pasada', 'error');
    }
    
    validarDatosGenerales();
}

function cargarTransaccionesRecojo() {
    const contenedor = document.getElementById('transaccionesRecojo');
    contenedor.innerHTML = transaccionesRecojo.map(transaccion => `
        <div class="recojo-item" onclick="toggleRecojoItem(${transaccion.id})">
            <input type="checkbox" class="recojo-checkbox" id="recojo_${transaccion.id}" onchange="toggleRecojoItem(${transaccion.id})">
            <div class="recojo-info">
                <div class="recojo-numero">${transaccion.numeroTransaccion}</div>
                <div class="recojo-direccion">
                    <strong>üìç ${transaccion.direccion}</strong><br>
                    üë§ Cliente: ${transaccion.cliente} | üìû ${transaccion.telefono}
                </div>
            </div>
        </div>
    `).join('');
}

function renderizarVehiculos() {
    const tbody = document.querySelector('#vehiculosTabla tbody');
    tbody.innerHTML = vehiculos.map(vehiculo => {
        // Conversi√≥n segura
        const capacidad = Number(vehiculo.capacidad);
        let capacidadUsada = Number(vehiculo.capacidad_usada);

        if (vehiculo.unidadid === vehiculoSeleccionado) {
            capacidadUsada = paquetesAsignados.length === 0 
                ? Number(vehiculo.capacidad_usada) 
                : pesoTotal;
        }

        const porcentaje = capacidad > 0 ? (capacidadUsada / capacidad) * 100 : 0;
        const isSelected = vehiculoSeleccionado === vehiculo.unidadid;

        return `
            <tr class="vehicle-row ${isSelected ? 'selected' : ''}" onclick="seleccionarVehiculo(${vehiculo.unidadid})">
                <td>${vehiculo.nombre_unidad}</td>
                <td>${capacidad.toFixed(2)}</td>
                <td>
                    <div class="capacity-bar">
                        <div class="capacity-fill ${porcentaje >= 90 ? 'danger' : porcentaje >= 70 ? 'warning' : ''}" 
                            style="width: ${Math.min(porcentaje, 100)}%"></div>
                    </div>
                    ${capacidadUsada.toFixed(2)} / ${capacidad.toFixed(2)} kg (${porcentaje.toFixed(1)}%)
                </td>
            </tr>
        `;
    }).join('');
}

function renderizarEmpleados() {
    const tbody = document.querySelector('#empleadosTabla tbody');
    tbody.innerHTML = empleados.map(empleado => {
        const yaAsignado = empleadosAsignados.some(e => e.id === empleado.id);
        
        return `
            <tr class="employee-row ${yaAsignado ? 'selected' : ''}" 
                onclick="toggleEmpleado(${empleado.id})">
                <td>${empleado.nombre}</td>
            </tr>
        `;
    }).join('');
}


function renderizarPaquetes() {
    const tbody = document.querySelector('#paquetesTabla tbody');
    
    // ‚úÖ CORREGIDO: Primero obtener paquetes disponibles
    if (!window.paquetesDisponibles) {
        window.paquetesDisponibles = obtenerPaquetesParaRuta();
    }
    
    // Verificar si hay paquetes disponibles
    if (!window.paquetesDisponibles || window.paquetesDisponibles.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="3" style="text-align: center; color: #666; font-style: italic;">
                    No hay paquetes disponibles para esta ruta
                </td>
            </tr>
        `;
        return;
    }
    
    tbody.innerHTML = window.paquetesDisponibles.map(paquete => {
        const yaAsignado = paquetesAsignados.some(p => p.id === paquete.id);
        
        // Colores por tipo
        let colorTipo = '#ecf0f1';
        let iconoTipo = 'üì¶';
        
        switch(paquete.tipo) {
            case 'largo_recorrido':
                colorTipo = '#e8f5e8'; // Verde claro
                iconoTipo = 'üöÄ';
                break;
            case 'entrega_intermedia':
                colorTipo = '#fff3cd'; // Amarillo claro
                iconoTipo = 'üì§';
                break;
            case 'recojo_intermedio':
                colorTipo = '#cce5ff'; // Azul claro
                iconoTipo = 'üì•';
                break;
            case 'entre_escalas':
                colorTipo = '#f8d7da'; // Rosa claro
                iconoTipo = 'üîÑ';
                break;
        }
        
        return `
            <tr class="package-row ${yaAsignado ? 'selected' : ''}" onclick="togglePaquete('${paquete.id}')">
                <td>
                    <strong style="color: #2c3e50;">${paquete.tracking}</strong>
                </td>
                <td>
                    <div style="background: ${colorTipo}; padding: 4px 8px; border-radius: 5px; margin-bottom: 4px; border-left: 3px solid #007bff;">
                        ${iconoTipo} ${paquete.descripcion}
                    </div>
                    <small style="color: #666;">Tipo: ${paquete.tipo.replace(/_/g, ' ')}</small>
                </td>
                <td>
                    <span style="background: #ecf0f1; padding: 4px 8px; border-radius: 8px; font-weight: 600;">
                        ${paquete.peso} kg
                    </span>
                </td>
            </tr>
        `;
    }).join('');
}

// ========================================
// FUNCI√ìN MEJORADA: cargarPaquetesParaRuta()
// ========================================

async function cargarPaquetesParaRuta() {
    if (!origenSeleccionado || !destinoSeleccionado) {
        console.log('‚ö†Ô∏è No hay origen o destino seleccionado');
        window.paquetesDisponibles = [];
        renderizarPaquetes();
        actualizarInfoPaquetes();
        return;
    }
    
    try {
        console.log('üîÑ Filtrando paquetes para la ruta...');
        console.log(`üìç Ruta: ${origenSeleccionado.nombre.split(' / ')[0]} ‚Üí ${destinoSeleccionado.nombre.split(' / ')[0]}`);
        
        if (escalas.length > 0) {
            console.log(`üìç Escalas: ${escalas.map(e => e.nombre.split(' / ')[0]).join(' ‚Üí ')}`);
        }
        
        // ‚úÖ Filtrar paquetes usando los datos ya cargados
        const paquetesParaRuta = obtenerPaquetesParaRuta();
        
        // ‚úÖ Actualizar variable global
        window.paquetesDisponibles = paquetesParaRuta;
        
        console.log(`üì¶ Resultado: ${paquetesParaRuta.length} paquetes disponibles`);
        
        // ‚úÖ Actualizar interfaz
        renderizarPaquetes();
        actualizarInfoPaquetes(paquetesParaRuta);
        
    } catch (error) {
        console.error('‚ùå Error filtrando paquetes:', error);
        window.paquetesDisponibles = [];
        renderizarPaquetes();
        actualizarInfoPaquetes([]);
    }
}

// Funci√≥n auxiliar para actualizar info de paquetes
function actualizarInfoPaquetes(paquetesParaRuta = []) {
    const infoElement = document.getElementById('infoPaquetes');
    if (!infoElement) return;
    
    if (paquetesParaRuta.length === 0) {
        infoElement.innerHTML = `
            <i class="fa-solid fa-info-circle"></i>
            No hay paquetes disponibles para la ruta seleccionada.
        `;
        infoElement.className = 'alert alert-warning';
    } else {
        // Crear resumen por tipo
        const resumenTipos = paquetesParaRuta.reduce((acc, paquete) => {
            const tipoLegible = paquete.tipo.replace(/_/g, ' ');
            acc[tipoLegible] = (acc[tipoLegible] || 0) + 1;
            return acc;
        }, {});
        
        const pesoTotal = paquetesParaRuta.reduce((sum, p) => sum + p.peso, 0);
        
        const resumenTexto = Object.entries(resumenTipos)
            .map(([tipo, cantidad]) => `${tipo}: ${cantidad}`)
            .join(', ');
        
        infoElement.innerHTML = `
            <i class="fa-solid fa-check-circle"></i>
            <strong>${paquetesParaRuta.length} paquetes disponibles</strong> 
            (${pesoTotal.toFixed(1)}kg total)<br>
            <small style="color: #666;">${resumenTexto}</small>
        `;
        infoElement.className = 'alert alert-info';
    }
}

// ========================================
// FUNCI√ìN AUXILIAR: Limpiar paquetes
// ========================================

function limpiarPaquetes() {
    window.paquetesDisponibles = [];
    paquetesAsignados = [];
    pesoTotal = 0;
    
    renderizarPaquetes();
    actualizarPaquetesAsignados();
    
    if (vehiculoSeleccionado) {
        actualizarCapacidadVehiculo();
    }
    
    console.log('üßπ Paquetes limpiados');
}

// ========================================
// INTEGRACI√ìN CON EL FLUJO PRINCIPAL
// ========================================

// Actualizar la funci√≥n validarDatosGenerales() para incluir la carga de paquetes
function validarDatosGenerales() {
    const fecha = document.getElementById('fecha').value;
    const hora = document.getElementById('hora').value;
    const origen = document.getElementById('origenSelect').value;
    const destino = document.getElementById('destinoSelect').value;
    
    const tabsContainer = document.getElementById('tabsContainer');
    const alertaDatos = document.getElementById('alertaDatosGenerales');
    const btnGuardar = document.getElementById('btnGuardar');
    
    const camposCompletos = [fecha, hora, origen, destino].filter(campo => campo).length;
    const totalCampos = 4;
    
    if (camposCompletos === totalCampos) {
        // Todos los datos est√°n completos
        tabsContainer.classList.remove('disabled');
        alertaDatos.style.display = 'none';
        btnGuardar.disabled = false;
        
        // Guardar datos del destino seleccionado
        const destinoSelect = document.getElementById('destinoSelect');
        const selectedDestino = destinoSelect.options[destinoSelect.selectedIndex];
        
        if (selectedDestino.dataset.lat && selectedDestino.dataset.lng) {
            destinoSeleccionado = {
                id: destino,
                nombre: selectedDestino.text,
                lat: parseFloat(selectedDestino.dataset.lat),
                lng: parseFloat(selectedDestino.dataset.lng)
            };
        } else {
            const destinoData = destinosDisponibles.find(d => d.sucursal_destino_id == destino);
            if (destinoData) {
                destinoSeleccionado = {
                    id: destino,
                    nombre: destinoData.nombre,
                    lat: parseFloat(destinoData.latitud),
                    lng: parseFloat(destinoData.longitud)
                };
            }
        }
        
        console.log('‚úÖ Origen:', origenSeleccionado);
        console.log('‚úÖ Destino:', destinoSeleccionado);
        
        // ‚úÖ CORREGIDO: Cargar paquetes para esta ruta
        cargarPaquetesParaRuta();
        
        // Actualizar mapa
        if (map) {
            actualizarMapaConRutaPrincipal();
        }
        
    } else {
        // Faltan datos
        tabsContainer.classList.add('disabled');
        alertaDatos.style.display = 'block';
        btnGuardar.disabled = true;
        
        // ‚úÖ CORREGIDO: Limpiar paquetes si no hay ruta completa
        limpiarPaquetes();
        
        // Mensaje din√°mico
        let mensaje = `Complete todos los datos generales para continuar (${camposCompletos}/${totalCampos}): `;
        const faltantes = [];
        
        if (!fecha) faltantes.push('Fecha de salida');
        if (!hora) faltantes.push('Hora de salida');
        if (!origen) faltantes.push('Origen');
        if (!destino) faltantes.push('Destino final');
        
        mensaje += faltantes.join(', ');
        
        alertaDatos.innerHTML = `
            <i class="fa-solid fa-info-circle"></i>
            ${mensaje}
            <div style="background: #fff; border-radius: 10px; margin-top: 8px; overflow: hidden;">
                <div style="background: #28a745; height: 4px; width: ${(camposCompletos/totalCampos)*100}%; transition: width 0.3s ease;"></div>
            </div>
        `;
    }
}


function verificarDatosPaquetes() {
    console.log('üîç Verificando estructura de datos...');
    
    if (!paquetes || !Array.isArray(paquetes)) {
        console.error('‚ùå La variable paquetes no existe o no es un array');
        return false;
    }
    
    console.log(`üìä Total paquetes cargados: ${paquetes.length}`);
    
    // Verificar que cada paquete tenga los campos obligatorios
    const erroresEncontrados = [];
    
    paquetes.forEach((paquete, index) => {
        const errores = [];
        
        if (!paquete.tracking) errores.push('Falta tracking');
        if (typeof paquete.peso !== 'number' && !paquete.peso) errores.push('Falta peso');
        if (!paquete.id_sucursal_origen) errores.push('Falta id_sucursal_origen');
        if (!paquete.sucursal_destino_id) errores.push('Falta sucursal_destino_id');
        
        if (errores.length > 0) {
            erroresEncontrados.push(`Paquete ${index}: ${errores.join(', ')}`);
            console.error(`‚ùå Paquete ${index}:`, errores, paquete);
        }
    });
    
    if (erroresEncontrados.length === 0) {
        console.log('‚úÖ Todos los paquetes tienen la estructura correcta');
        
        // Mostrar ejemplo de paquete
        if (paquetes.length > 0) {
            console.log('üìã Ejemplo de paquete:', paquetes[0]);
        }
        
        return true;
    } else {
        console.error('‚ùå Errores encontrados:', erroresEncontrados);
        return false;
    }
}

function obtenerPaquetesParaRuta() {
    if (!origenSeleccionado || !destinoSeleccionado) return [];
    
    // Crear ruta completa: [origen, escalas..., destino]
    const rutaCompleta = [
        { id: parseInt(origenSeleccionado.id), nombre: origenSeleccionado.nombre },
        ...escalas.map(escala => ({ id: escala.id, nombre: escala.nombre })),
        { id: parseInt(destinoSeleccionado.id), nombre: destinoSeleccionado.nombre }
    ];
    
    console.log('üó∫Ô∏è Ruta completa:', rutaCompleta);
    
    // Filtrar paquetes que tengan origen y destino en esta ruta
    const paquetesValidos = paquetes.filter(paquete => {
        const origenEnRuta = rutaCompleta.some(punto => punto.id == paquete.id_sucursal_origen);
        const destinoEnRuta = rutaCompleta.some(punto => punto.id == paquete.sucursal_destino_id);
        
        return origenEnRuta && destinoEnRuta && 
               paquete.id_sucursal_origen != paquete.sucursal_destino_id;
    });
    
    console.log(`üì¶ Paquetes v√°lidos: ${paquetesValidos.length}`);
    
    // Categorizar cada paquete
    const paquetesCategorizados = paquetesValidos.map(paquete => {
        const indiceCarga = rutaCompleta.findIndex(punto => punto.id == paquete.id_sucursal_origen);
        const indiceDescarga = rutaCompleta.findIndex(punto => punto.id == paquete.sucursal_destino_id);
        
        let tipo = 'invalido';
        let descripcionRuta = '';
        
        if (indiceCarga !== -1 && indiceDescarga !== -1 && indiceCarga < indiceDescarga) {
            const puntoOrigen = rutaCompleta[indiceCarga].nombre.split(' / ')[0];
            const puntoDestino = rutaCompleta[indiceDescarga].nombre.split(' / ')[0];
            
            if (indiceCarga === 0 && indiceDescarga === rutaCompleta.length - 1) {
                tipo = 'largo_recorrido';
                descripcionRuta = `${puntoOrigen} ‚Üí ${puntoDestino} (Viaje completo)`;
            } else if (indiceCarga === 0) {
                tipo = 'entrega_intermedia';
                descripcionRuta = `${puntoOrigen} ‚Üí ${puntoDestino} (Entrega en ruta)`;
            } else if (indiceDescarga === rutaCompleta.length - 1) {
                tipo = 'recojo_intermedio';
                descripcionRuta = `${puntoOrigen} ‚Üí ${puntoDestino} (Recojo en ruta)`;
            } else {
                tipo = 'entre_escalas';
                descripcionRuta = `${puntoOrigen} ‚Üí ${puntoDestino} (Entre escalas)`;
            }
        }
        
        return {
            id: paquete.tracking,              // ‚úÖ Usar tracking como ID √∫nico
            tracking: paquete.tracking,        // ‚úÖ Del campo p.tracking
            descripcion: descripcionRuta,      // ‚úÖ Generada autom√°ticamente
            peso: parseFloat(paquete.peso),    // ‚úÖ Del campo p.peso
            punto_carga: indiceCarga,
            punto_descarga: indiceDescarga,
            tipo: tipo,
            origen_id: paquete.id_sucursal_origen,    // ‚úÖ Del campo te.id_sucursal_origen
            destino_id: paquete.sucursal_destino_id   // ‚úÖ Del campo p.sucursal_destino_id
        };
    });
    
    return paquetesCategorizados.filter(p => p.tipo !== 'invalido');
}

function seleccionarVehiculo(vehiculoId) {
    vehiculoSeleccionado = vehiculoId;
    const vehiculo = vehiculos.find(v => v.unidadid === vehiculoId);
    
    document.getElementById('vehiculoSeleccionado').style.display = 'block';
    document.getElementById('vehiculoInfo').innerHTML = `
        <span class="item-tag">${vehiculo.nombre_unidad} - Capacidad: ${vehiculo.capacidad}kg</span>
    `;
    
    actualizarCapacidadVehiculo();
    renderizarVehiculos();
    hideAlert('errorVehiculo');
}

function toggleEmpleado(empleadoId) {
    const empleado = empleados.find(e => e.id === empleadoId);
    const index = empleadosAsignados.findIndex(e => e.id === empleadoId);
    
    if (index === -1) {
        empleadosAsignados.push(empleado);
    } else {
        empleadosAsignados.splice(index, 1);
    }
    
    actualizarEmpleadosAsignados();
    renderizarEmpleados();
}

function togglePaquete(paqueteId) {
    if (!vehiculoSeleccionado) {
        showAlert('errorPaquetes', 'Debe seleccionar un veh√≠culo antes de agregar paquetes', 'error');
        return;
    }

    const paquete = window.paquetesDisponibles.find(p => p.id === paqueteId);
    const vehiculo = vehiculos.find(v => v.unidadid === vehiculoSeleccionado);
    const index = paquetesAsignados.findIndex(p => p.id === paqueteId);
    
    if (index === -1) {
        // ‚úÖ USAR NUEVA VALIDACI√ìN
        const validacion = PaquetesManager.puedeAgregarPaquete(
            paquete, 
            paquetesAsignados, 
            vehiculo.capacidad
        );
        
        if (!validacion.puedeAgregar) {
            showAlert('errorPaquetes', 
                `No se puede agregar el paquete: ${validacion.razon}`, 'error');
            return;
        }
        
        paquetesAsignados.push(paquete);
        pesoTotal += paquete.peso;
    } else {
        // Remover paquete
        pesoTotal -= paquete.peso;
        paquetesAsignados.splice(index, 1);
    }
    
    actualizarPaquetesAsignados();
    actualizarCapacidadVehiculo();
    renderizarPaquetes();
    hideAlert('errorPaquetes');
    
    // ‚úÖ MOSTRAR INFORMACI√ìN DETALLADA
    mostrarCapacidadPorTramos();
}

function toggleRecojoItem(transaccionId) {
    const transaccion = transaccionesRecojo.find(t => t.id === transaccionId);
    const index = recojosAsignados.findIndex(r => r.id === transaccionId);
    const checkbox = document.getElementById(`recojo_${transaccionId}`);
    const item = document.querySelector(`#recojo_${transaccionId}`).closest('.recojo-item');
    
    if (index === -1) {
        recojosAsignados.push(transaccion);
        checkbox.checked = true;
        item.classList.add('selected');
    } else {
        recojosAsignados.splice(index, 1);
        checkbox.checked = false;
        item.classList.remove('selected');
    }
    
    actualizarRecojosAsignados();
}

function actualizarEmpleadosAsignados() {
    const contenedor = document.getElementById('empleadosAsignados');
    if (empleadosAsignados.length === 0) {
        contenedor.innerHTML = '<span style="color: #666; font-style: italic;">No hay empleados asignados</span>';
    } else {
        contenedor.innerHTML = empleadosAsignados.map(empleado => 
            `<span class="item-tag">
                ${empleado.nombre} 
                <button class="remove-btn" onclick="toggleEmpleado(${empleado.id})">√ó</button>
            </span>`
        ).join('');
    }
}

function actualizarPaquetesAsignados() {
    const contenedor = document.getElementById('paquetesAsignados');
    if (paquetesAsignados.length === 0) {
        contenedor.innerHTML = '<span style="color: #666; font-style: italic;">No hay paquetes asignados</span>';
    } else {
        contenedor.innerHTML = paquetesAsignados.map(paquete => 
            `<span class="item-tag">
                ${paquete.tracking} - ${paquete.peso}kg
                <button class="remove-btn" onclick="togglePaquete(${paquete.id})">√ó</button>
            </span>`
        ).join('');
    }
}

function actualizarRecojosAsignados() {
    const contenedor = document.getElementById('recojosAsignados');
    if (recojosAsignados.length === 0) {
        contenedor.innerHTML = '<span style="color: #666; font-style: italic;">No hay recojos seleccionados</span>';
    } else {
        contenedor.innerHTML = recojosAsignados.map(recojo => 
                            `<span class="item-tag">
                ${recojo.numeroTransaccion} - ${recojo.cliente}
                <button class="remove-btn" onclick="toggleRecojoItem(${recojo.id})">√ó</button>
            </span>`
        ).join('');
    }
}

function actualizarCapacidadVehiculo() {
    if (!vehiculoSeleccionado) return;

    const vehiculo = vehiculos.find(v => v.unidadid === vehiculoSeleccionado);
    const capacidad = Number(vehiculo.capacidad);

    // Si no hay paquetes asignados, usar lo que viene de backend
    const capacidadUsada = paquetesAsignados.length === 0 
        ? Number(vehiculo.capacidad_usada) 
        : pesoTotal;

    const porcentaje = capacidad > 0 ? (capacidadUsada / capacidad) * 100 : 0;

    document.getElementById('capacityText').textContent = 
        `${capacidadUsada.toFixed(2)} kg / ${capacidad.toFixed(2)} kg (${porcentaje.toFixed(1)}%)`;

    const fill = document.getElementById('capacityFill');
    fill.style.width = `${Math.min(porcentaje, 100)}%`;
    fill.className = 'capacity-fill';
    if (porcentaje >= 90) fill.classList.add('danger');
    else if (porcentaje >= 70) fill.classList.add('warning');
}

// ========================================
// FUNCIONES PARA MANEJO DE ESCALAS
// ========================================

function mostrarAgenciasEnMapa() {
    if (!map) return;

    // Limpiar marcadores anteriores
    agenciaMarkers.forEach(marker => map.removeLayer(marker));
    agenciaMarkers = [];

    agencias.forEach(agencia => {
        if (agencia.lat && agencia.lng) {
            // Verificar si esta agencia ya est√° en escalas
            const yaEsEscala = escalas.some(escala => escala.id === agencia.id);
            
            // Verificar si es origen o destino
            const esOrigen = origenSeleccionado && agencia.id == origenSeleccionado.id;
            const esDestino = destinoSeleccionado && agencia.id == destinoSeleccionado.id;
            const esOrigenODestino = esOrigen || esDestino;
            
            const marker = L.marker([agencia.lat, agencia.lng]).addTo(map);
            
            // Crear popup din√°mico
            let popupContent = `
                <strong>${agencia.nombre}</strong><br>
                üìç ${agencia.direccion}<br>
                üìû ${agencia.telefono || 'Sin tel√©fono'}<br>
                üïí ${agencia.horario || 'Horario no disponible'}<br>
                üìç ${agencia.distrito}, ${agencia.provincia}<br>
            `;
            
            if (esOrigenODestino) {
                // Si es origen o destino, mostrar mensaje informativo
                popupContent += `
                    <div style="background: #e3f2fd; padding: 8px; border-radius: 5px; margin-top: 8px; font-size: 0.8rem; color: #1976d2;">
                        <i class="fa-solid fa-info-circle"></i>
                        ${esOrigen ? 'üöÄ Esta es su sucursal de ORIGEN' : 'üéØ Esta es su sucursal de DESTINO'}
                    </div>
                `;
            } else if (yaEsEscala) {
                // Si ya es una escala, mostrar bot√≥n para quitar
                popupContent += `
                    <button onclick="eliminarEscalaDesdeMapa(${agencia.id})" class="btn-eliminar-escala">
                        ‚ùå Quitar escala
                    </button>
                `;
            } else {
                // Si no es origen, destino ni escala, mostrar bot√≥n para agregar
                popupContent += `
                    <button onclick="agregarEscalaDesdeMapa(${agencia.id})" class="btn-agregar-escala">
                        ‚ûï Agregar como escala
                    </button>
                `;
            }
            
            marker.bindPopup(popupContent);
            
            // Evento de doble clic solo si no es origen o destino
            if (!esOrigenODestino) {
                marker.on('dblclick', function() {
                    if (yaEsEscala) {
                        eliminarEscalaDesdeMapa(agencia.id);
                    } else {
                        agregarEscalaDesdeMapa(agencia.id);
                    }
                });
            }

            agenciaMarkers.push(marker);
        }
    });

    // Ajustar vista si hay marcadores
    if (agenciaMarkers.length > 0) {
        const group = new L.featureGroup(agenciaMarkers);
        map.fitBounds(group.getBounds().pad(0.1));
    }
}

function agregarEscalaDesdeMapa(idAgencia) {
    // Verificar que no sea origen o destino
    if (origenSeleccionado && idAgencia == origenSeleccionado.id) {
        alert("No puede agregar la sucursal de origen como escala");
        return;
    }
    
    if (destinoSeleccionado && idAgencia == destinoSeleccionado.id) {
        alert("No puede agregar la sucursal de destino como escala");
        return;
    }
    
    // Verificar l√≠mite m√°ximo
    if (escalas.length >= MAX_ESCALAS) {
        alert(`M√°ximo ${MAX_ESCALAS} escalas permitidas`);
        return;
    }

    const agencia = agencias.find(a => a.id === parseInt(idAgencia));
    
    if (!agencia) {
        alert("No se encontr√≥ la agencia.");
        return;
    }

    if (escalas.some(e => e.id === idAgencia)) {
        alert("Esta agencia ya ha sido agregada como escala.");
        return;
    }

    escalas.push(agencia);
    actualizarEscalas();
    mostrarAgenciasEnMapa(); // Actualizar marcadores
    actualizarRutaEnMapa();
    
    // Recargar paquetes con las nuevas escalas
    cargarPaquetesParaRuta();
}

function eliminarEscalaDesdeMapa(idAgencia) {
    escalas = escalas.filter(e => e.id !== parseInt(idAgencia));
    actualizarEscalas();
    mostrarAgenciasEnMapa(); // Actualizar marcadores
    actualizarRutaEnMapa();
    
    // Recargar paquetes sin la escala eliminada
    cargarPaquetesParaRuta();
}

function actualizarEscalas() {
    const contenedor = document.getElementById('escalasLista');
    
    if (escalas.length === 0) {
        contenedor.innerHTML = '<span style="color: #666; font-style: italic;">No hay escalas programadas</span>';
    } else {
        contenedor.innerHTML = escalas.map((escala, index) => 
            `<div class="escala-item" draggable="true" ondragstart="iniciarArrastre(event, ${index})" ondragover="permitirSoltar(event)" ondrop="soltarEscala(event, ${index})">
                <div class="escala-number">${index + 1}</div>
                <div style="flex: 1;">
                    <strong>${escala.nombre}</strong><br>
                    <small style="color: #666;">üìç ${escala.direccion}</small><br>
                    <small style="color: #888;">üèõÔ∏è ${escala.distrito}, ${escala.provincia}</small>
                </div>
                <div style="display: flex; gap: 5px;">
                    <button class="btn btn-secondary" onclick="subirEscala(${index})" style="padding: 5px 8px; font-size: 0.7rem;" title="Subir escala">
                        <i class="fa-solid fa-arrow-up"></i>
                    </button>
                    <button class="btn btn-secondary" onclick="bajarEscala(${index})" style="padding: 5px 8px; font-size: 0.7rem;" title="Bajar escala">
                        <i class="fa-solid fa-arrow-down"></i>
                    </button>
                    <button class="btn btn-danger" onclick="eliminarEscala(${escala.id})" style="padding: 5px 10px; font-size: 0.8rem;">
                        <i class="fa-solid fa-trash"></i> Quitar
                    </button>
                </div>
            </div>`
        ).join('');
    }
    
    actualizarContadorEscalas();
    actualizarRutaEnMapa();
    if (origenSeleccionado && destinoSeleccionado) {
    cargarPaquetesParaRuta();
}
}

function eliminarEscala(agenciaId) {
    escalas = escalas.filter(e => e.id !== agenciaId);
    actualizarEscalas();
    mostrarAgenciasEnMapa();
    cargarPaquetesParaRuta();
}

function actualizarContadorEscalas() {
    document.getElementById('contadorEscalas').textContent = escalas.length;
}

function actualizarRutaEnMapa() {
    if (!map) return;
    
    // Limpiar ruta anterior
    if (rutaLayer) {
        map.removeLayer(rutaLayer);
        rutaLayer = null;
    }
    
    // Limpiar marcadores de escalas anteriores
    escalasMarkers.forEach(marker => map.removeLayer(marker));
    escalasMarkers = [];
    
    // Crear array de puntos para la ruta completa
    let puntosRuta = [];
    
    // Agregar origen si existe
    if (origenSeleccionado) {
        puntosRuta.push([origenSeleccionado.lat, origenSeleccionado.lng]);
    }
    
    // Agregar escalas en orden
    escalas.forEach((escala, index) => {
        if (escala.lat && escala.lng) {
            puntosRuta.push([escala.lat, escala.lng]);
            
            // Crear marcador numerado para la escala
            const marker = L.marker([escala.lat, escala.lng], {
                icon: L.divIcon({
                    className: 'marker-numero marker-escala',
                    html: `<div class="marker-numero marker-escala">${index + 1}</div>`,
                    iconSize: [30, 30],
                    iconAnchor: [15, 15]
                })
            }).addTo(map);
            
            marker.bindPopup(`
                <strong>Escala ${index + 1}: ${escala.nombre}</strong><br>
                üìç ${escala.direccion}<br>
                üèõÔ∏è ${escala.distrito}, ${escala.provincia}<br>
                <button onclick="eliminarEscala(${escala.id})" class="btn-eliminar-escala">
                    ‚ùå Quitar escala
                </button>
            `);
            
            escalasMarkers.push(marker);
        }
    });
    
    // Agregar destino final si existe
    if (destinoSeleccionado) {
        puntosRuta.push([destinoSeleccionado.lat, destinoSeleccionado.lng]);
    }
    
    // Crear l√≠nea de ruta si hay al menos 2 puntos
    if (puntosRuta.length >= 2) {
        rutaLayer = L.polyline(puntosRuta, { 
            color: '#007bff', 
            weight: 4,
            opacity: 0.7
        }).addTo(map);
        
        // Ajustar vista a la ruta completa
        const allMarkers = [];
        if (origenMarker) allMarkers.push(origenMarker);
        if (destinoMarker) allMarkers.push(destinoMarker);
        allMarkers.push(...escalasMarkers);
        
        if (allMarkers.length > 0) {
            const group = new L.featureGroup(allMarkers);
            map.fitBounds(group.getBounds(), { padding: [20, 20] });
        }
    }
}

// Funciones para drag & drop de escalas
let elementoArrastrado = null;

function iniciarArrastre(event, index) {
    elementoArrastrado = index;
    event.dataTransfer.effectAllowed = "move";
}

function permitirSoltar(event) {
    event.preventDefault();
}

function soltarEscala(event, index) {
    event.preventDefault();
    
    if (elementoArrastrado !== null && elementoArrastrado !== index) {
        // Reordenar escalas
        const escalaMovida = escalas[elementoArrastrado];
        escalas.splice(elementoArrastrado, 1);
        escalas.splice(index, 0, escalaMovida);
        
        actualizarEscalas();
        actualizarRutaEnMapa();
    }
    
    elementoArrastrado = null;
}

// Funciones para reordenar escalas
function subirEscala(index) {
    if (index === 0) {
        alert('Esta escala ya se encuentra en la primera posici√≥n');
        return;
    }
    
    // Intercambiar posiciones
    const temp = escalas[index];
    escalas[index] = escalas[index - 1];
    escalas[index - 1] = temp;
    
    actualizarEscalas();
    actualizarRutaEnMapa();
}

function bajarEscala(index) {
    if (index === escalas.length - 1) {
        alert('Esta escala ya se encuentra en la √∫ltima posici√≥n');
        return;
    }
    
    // Intercambiar posiciones
    const temp = escalas[index];
    escalas[index] = escalas[index + 1];
    escalas[index + 1] = temp;
    
    actualizarEscalas();
    actualizarRutaEnMapa();
}

function toggleRecojoSection() {
    const checkbox = document.getElementById('recojoCheckbox');
    const section = document.getElementById('recojoSection');
    
    if (checkbox.checked) {
        section.classList.add('show');
    } else {
        section.classList.remove('show');
        recojosAsignados = [];
        transaccionesRecojo.forEach(transaccion => {
            const checkbox = document.getElementById(`recojo_${transaccion.id}`);
            const item = document.querySelector(`#recojo_${transaccion.id}`).closest('.recojo-item');
            if (checkbox) checkbox.checked = false;
            if (item) item.classList.remove('selected');
        });
        actualizarRecojosAsignados();
    }
}

function showAlert(elementId, mensaje, tipo) {
    const elemento = document.getElementById(elementId);
    elemento.innerHTML = mensaje;
    elemento.className = `alert alert-${tipo} show`;
    
    // Auto-ocultar despu√©s de 5 segundos, excepto para warnings importantes
    if (tipo !== 'warning' || !mensaje.includes('30 minutos')) {
        setTimeout(() => {
            elemento.classList.remove('show');
        }, 5000);
    } else {
        // Para warnings importantes, mantener visible m√°s tiempo
        setTimeout(() => {
            elemento.classList.remove('show');
        }, 8000);
    }
}

function hideAlert(elementId) {
    const elemento = document.getElementById(elementId);
    elemento.classList.remove('show');
}

function validarFormulario() {
    const fecha = document.getElementById('fecha').value;
    const hora = document.getElementById('hora').value;
    const origen = document.getElementById('origenSelect').value;
    const destino = document.getElementById('destinoSelect').value;
    
    // Validar fecha y hora futuras
    const ahora = new Date();
    const fechaHoraSeleccionada = new Date(`${fecha}T${hora}`);
    
    if (fechaHoraSeleccionada <= ahora) {
        showAlert('mensajeGuardado', 'La fecha y hora de salida deben ser posteriores a la actual', 'error');
        return false;
    }
    
    if (!fecha) {
        showAlert('mensajeGuardado', 'Por favor, seleccione una fecha', 'error');
        return false;
    }
    
    if (!hora) {
        showAlert('mensajeGuardado', 'Por favor, seleccione una hora', 'error');
        return false;
    }
    
    if (!origen) {
        showAlert('mensajeGuardado', 'Por favor, seleccione un origen', 'error');
        return false;
    }
    
    if (!destino) {
        showAlert('mensajeGuardado', 'Por favor, seleccione un destino', 'error');
        return false;
    }
    
    if (!vehiculoSeleccionado) {
        showAlert('mensajeGuardado', 'Por favor, seleccione un veh√≠culo', 'error');
        return false;
    }
    
    if (empleadosAsignados.length === 0) {
        showAlert('mensajeGuardado', 'Debe asignar al menos un empleado', 'error');
        return false;
    }
    
    if (paquetesAsignados.length === 0) {
        showAlert('mensajeGuardado', 'Debe asignar al menos un paquete', 'error');
        return false;
    }
    
    return true;
}

function obtenerDatosSalida() {
    // Crear array con IDs de todas las sucursales involucradas
    const sucursalesIds = [origenSeleccionado.id, destinoSeleccionado.id];
    escalas.forEach(escala => {
        if (!sucursalesIds.includes(escala.id)) {
            sucursalesIds.push(escala.id);
        }
    });
    
    return {
        // Datos generales
        fecha: document.getElementById('fecha').value,
        hora: document.getElementById('hora').value,
        
        // Ruta
        sucursal_origen_id: origenSeleccionado.id,
        sucursal_destino_id: destinoSeleccionado.id,
        escalas_ids: escalas.map(escala => escala.id),
        sucursales_involucradas: sucursalesIds,
        
        // Recursos asignados
        vehiculo_id: vehiculoSeleccionado,
        empleados_ids: empleadosAsignados.map(emp => emp.id),
        paquetes_ids: paquetesAsignados.map(paq => paq.id),
        
        // Opcionales
        incluye_recojos: document.getElementById('recojoCheckbox').checked,
        recojos_ids: recojosAsignados.map(rec => rec.id),
        
        // Peso total
        peso_total: pesoTotal,
        
        // Metadata para debug
        fecha_creacion: new Date().toISOString()
    };
}

function guardarSalida() {
    if (!validarFormulario()) {
        return;
    }
    
    const datosSalida = obtenerDatosSalida();
    
    console.log('Datos completos de la salida:', datosSalida);
    
    // TODO: Aqu√≠ har√≠as la llamada real al backend para guardar
    /*
    fetch('/guardar_salida_api', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(datosSalida)
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 1) {
            showAlert('mensajeGuardado', 'Salida guardada exitosamente', 'success');
        } else {
            showAlert('mensajeGuardado', 'Error al guardar: ' + data.msg, 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('mensajeGuardado', 'Error de conexi√≥n', 'error');
    });
    */
    
    // Por ahora mostrar mensaje de √©xito con resumen
    const vehiculo = vehiculos.find(v => v.unidadid === vehiculoSeleccionado);
    let mensajeEscalas = '';
    if (escalas.length > 0) {
        mensajeEscalas = `, Escalas: ${escalas.map(e => e.nombre.split(' - ')[0]).join(' ‚Üí ')}`;
    }
    
    let mensajeRecojos = '';
    if (datosSalida.incluye_recojos && recojosAsignados.length > 0) {
        mensajeRecojos = `, Con ${recojosAsignados.length} recojo(s) en casa`;
    }
    
    showAlert('mensajeGuardado', 
        `‚úÖ Salida programada exitosamente para el ${datosSalida.fecha} a las ${datosSalida.hora}. 
        Ruta: ${origenSeleccionado.nombre.split(' / ')[0]} ‚Üí ${destinoSeleccionado.nombre.split(' / ')[0]}. 
        Veh√≠culo: ${vehiculo.nombre_unidad}, 
        Empleados: ${empleadosAsignados.length}, 
        Paquetes: ${paquetesAsignados.length}, 
        Peso total: ${pesoTotal}kg${mensajeEscalas}${mensajeRecojos}`, 
        'success');
}
</script>
{% endblock  %}