{% extends "MAESTRA_ADMIN.html" %}

{% block estilos %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.21.1/axios.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<style>

    /* ========================================
   ESTILOS PARA CONTROL DE CAPACIDAD POR TRAMOS
   ======================================== */

.control-capacidad-tramos {
    margin-top: 20px;
    background: #fff;
    border-radius: 12px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    overflow: hidden;
}

.vehiculo-control-card {
    border: 1px solid #e0e0e0;
    border-radius: 12px;
    overflow: hidden;
}

.vehiculo-resumen {
    display: flex;
    align-items: center;
    padding: 20px;
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    border-bottom: 1px solid #dee2e6;
}

.vehiculo-icon {
    font-size: 2.5rem;
    margin-right: 15px;
    background: #fff;
    width: 60px;
    height: 60px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.vehiculo-info {
    flex: 1;
}

.vehiculo-info h3 {
    margin: 0 0 8px 0;
    font-size: 1.1rem;
    color: #2c3e50;
    font-weight: 600;
}

.vehiculo-tag {
    background: #28a745;
    color: white;
    padding: 8px 16px;
    border-radius: 20px;
    font-size: 0.9rem;
    font-weight: 500;
    display: inline-block;
}

.capacidad-general {
    font-size: 1.2rem;
    font-weight: 700;
    color: #2c3e50;
    text-align: right;
    min-width: 200px;
}

.barra-capacidad-general {
    padding: 0 20px 20px 20px;
}

.barra-fondo {
    width: 100%;
    height: 20px;
    margin-top: 18px;
    background-color: #e9ecef;
    border-radius: 10px;
    overflow: hidden;
    position: relative;
}

.barra-relleno {
    height: 100%;
    transition: width 0.3s ease;
    border-radius: 10px;
    position: relative;
}

.barra-relleno.dentro-limite {
    background: linear-gradient(90deg, #28a745 0%, #20c997 100%);
}

.barra-relleno.cerca-limite {
    background: linear-gradient(90deg, #ffc107 0%, #fd7e14 100%);
}

.barra-relleno.excede-limite {
    background: linear-gradient(90deg, #dc3545 0%, #e91e63 100%);
}

.vehiculo-seleccionado-card {
    background: #f8f9fa;
    border-radius: 8px;
    padding: 15px;
}

.vehiculo-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    flex-wrap: wrap;
    gap: 10px;
}

.vehiculo-nombre {
    font-weight: 600;
    font-size: 1.1rem;
    color: #2c3e50;
}

.vehiculo-capacidad {
    color: #6c757d;
    font-size: 0.9rem;
}

.btn-cambiar-vehiculo {
    background: #6c757d;
    color: white;
    border: none;
    padding: 8px 12px;
    border-radius: 6px;
    font-size: 0.8rem;
    cursor: pointer;
    transition: all 0.3s ease;
}

.btn-cambiar-vehiculo:hover {
    background: #5a6268;
    transform: translateY(-1px);
}

.detalle-tramos {
    background: #fff;
    border-top: 1px solid #dee2e6;
}

.detalle-header {
    display: flex;
    align-items: center;
    padding: 15px 20px;
    background: #f8f9fa;
    border-bottom: 1px solid #dee2e6;
}

.detalle-icon {
    font-size: 1.5rem;
    margin-right: 10px;
}

.detalle-header h4 {
    margin: 0;
    color: #2c3e50;
    font-size: 1rem;
    font-weight: 600;
}

.tabla-tramos {
    display: flex;
    flex-direction: column;
}

.tabla-header {
    display: grid;
    grid-template-columns: 2fr 1.5fr 1.5fr;
    gap: 15px;
    padding: 15px 20px;
    background: #e9ecef;
    font-weight: 600;
    color: #495057;
    font-size: 0.9rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.fila-tramo {
    display: grid;
    grid-template-columns: 2fr 1.5fr 1.5fr;
    gap: 15px;
    padding: 15px 20px;
    border-bottom: 1px solid #f1f3f4;
    transition: background-color 0.2s ease;
}

.fila-tramo:hover {
    background-color: #f8f9fa;
}

.fila-tramo:last-child {
    border-bottom: none;
}

.columna-tramo strong {
    color: #2c3e50;
    font-size: 0.95rem;
}

.columna-peso {
    display: flex;
    flex-direction: column;
    gap: 6px;
}

.peso-valor {
    font-weight: 600;
    color: #2c3e50;
    font-size: 0.95rem;
}

.barra-mini {
    width: 100%;
    height: 8px;
    background-color: #e9ecef;
    border-radius: 4px;
    overflow: hidden;
}

.barra-mini-relleno {
    height: 100%;
    border-radius: 4px;
    transition: width 0.3s ease;
}

.barra-mini-relleno.dentro-limite {
    background: #28a745;
}

.barra-mini-relleno.cerca-limite {
    background: #ffc107;
}

.barra-mini-relleno.excede-limite {
    background: #dc3545;
}

.porcentaje {
    color: #6c757d;
    font-size: 0.8rem;
    font-weight: 500;
}

.estado-badge {
    padding: 6px 12px;
    border-radius: 15px;
    font-size: 0.8rem;
    font-weight: 500;
    white-space: nowrap;
}

.estado-badge.dentro-limite {
    background: #d4edda;
    color: #155724;
    border: 1px solid #c3e6cb;
}

.estado-badge.cerca-limite {
    background: #fff3cd;
    color: #856404;
    border: 1px solid #ffeaa7;
}

.estado-badge.excede-limite {
    background: #f8d7da;
    color: #721c24;
    border: 1px solid #f5c6cb;
}

/* Responsive */
@media (max-width: 768px) {
    .vehiculo-resumen {
        flex-direction: column;
        text-align: center;
        gap: 15px;
    }
    
    .vehiculo-header {
        flex-direction: column;
        text-align: center;
    }
    
    .tabla-header,
    .fila-tramo {
        grid-template-columns: 1fr;
        gap: 10px;
    }
    
    .tabla-header {
        display: none; /* Ocultar headers en móvil */
    }
    
    .fila-tramo {
        border: 1px solid #dee2e6;
        border-radius: 8px;
        margin-bottom: 10px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    
    .columna-tramo::before {
        content: "Tramo: ";
        font-weight: 600;
        color: #6c757d;
    }
    
    .columna-peso::before {
        content: "Peso: ";
        font-weight: 600;
        color: #6c757d;
    }
    
    .columna-estado::before {
        content: "Estado: ";
        font-weight: 600;
        color: #6c757d;
    }
}

/* Animaciones */
@keyframes slideIn {
    from {
        opacity: 0;
        transform: translateY(-10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.control-capacidad-tramos {
    animation: slideIn 0.3s ease;
}

.barra-relleno::after {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    height: 100%;
    width: 100%;
    background: linear-gradient(90deg, transparent 0%, rgba(255,255,255,0.2) 50%, transparent 100%);
    animation: shimmer 2s infinite;
}

@keyframes shimmer {
    0% { transform: translateX(-100%); }
    100% { transform: translateX(100%); }
}
#map {
  height: 400px;
  width: 100%;
  border-radius: 10px;
  margin-top: 10px;
}

.leaflet-popup-content .btn-agregar-escala {
    display: inline-block;
    background-color: #28a745;
    color: white;
    padding: 4px 10px;
    font-size: 0.8rem;
    border: none;
    border-radius: 5px;
    margin-top: 6px;
    cursor: pointer;
}

.leaflet-popup-content .btn-eliminar-escala {
    display: inline-block;
    background-color: #dc3545;
    color: white;
    padding: 4px 10px;
    font-size: 0.8rem;
    border: none;
    border-radius: 5px;
    margin-top: 6px;
    cursor: pointer;
    margin-left: 5px;
}

/* Estilos para marcadores numerados */
.marker-numero {
    background-color: #007bff;
    color: white;
    border-radius: 50%;
    width: 30px;
    height: 30px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    font-size: 14px;
    border: 2px solid white;
    box-shadow: 0 2px 6px rgba(0,0,0,0.3);
}

.marker-escala {
    background-color: #28a745;
}

.marker-origen {
    background-color: #ff6b6b;
}

.marker-destino {
    background-color: #4ecdc4;
}

/* Estilos para las escalas */
.escala-item {
    display: flex;
    align-items: center;
    padding: 10px;
    border: 1px solid #ddd;
    border-radius: 8px;
    margin-bottom: 8px;
    background: white;
    cursor: pointer;
    transition: all 0.3s ease;
}

.escala-item:hover {
    background: #f8f9fa;
    border-color: #007bff;
}

.escala-number {
    background: #007bff;
    color: white;
    border-radius: 50%;
    width: 30px;
    height: 30px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    margin-right: 15px;
    flex-shrink: 0;
}

.escalas-info {
    background: #e3f2fd;
    padding: 10px;
    border-radius: 8px;
    margin-bottom: 15px;
    font-size: 0.9rem;
    color: #1976d2;
}

.escalas-controles {
    display: flex;
    gap: 10px;
    margin-bottom: 15px;
    flex-wrap: wrap;
}

.escalas-controles button {
    padding: 8px 15px;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    font-size: 0.9rem;
    transition: all 0.3s ease;
}

.btn-limpiar {
    background-color: #6c757d;
    color: white;
}

.btn-limpiar:hover {
    background-color: #5a6268;
}

.btn-optimizar {
    background-color: #17a2b8;
    color: white;
}

.btn-secondary {
    background-color: #6c757d;
    color: white;
}

.btn-secondary:hover {
    background-color: #5a6268;
}

/* Estilos para pestañas deshabilitadas */
.tabs-container.disabled {
    opacity: 0.5;
    pointer-events: none;
}

.form-disabled {
    opacity: 0.6;
    pointer-events: none;
}

.alert-info {
    background-color: #d1ecf1;
    border-color: #bee5eb;
    color: #0c5460;
    padding: 10px;
    border-radius: 5px;
    margin-bottom: 15px;
}
</style>
<link rel="stylesheet" href="/static/css/salida_informacion.css">

{% endblock estilos %}

{% block titulo %}
Programar nueva salida
{% endblock %}

{% block contenido %}

  <div class="container">
        <!-- Header -->
    <div class="block_crud block_title" style="padding: 20px 10px 30px 10px; font-size: 1rem;">
  <h3 class="crud_title">
    <i class="{{page_icono}}"></i> 
    {{page_titulo}}
  </h3>
</div>

        <!-- Resumen Superior -->
        <div class="summary-container">
            <h2 class="summary-title">
                <i class="fa-solid fa-chart-line"></i>
                Programación de la Salida
            </h2>

            <!-- Datos Generales aquí -->
            <div class="general-data-section">
                <h3 class="general-title">
                    <i class="fa-solid fa-calendar-days"></i>
                    Datos Generales
                </h3>
                <div class="form-group">
                    <div class="form-field">
                        <label for="fecha">Fecha de salida:</label>
                        <input type="date" id="fecha" required onchange="validarDatosGenerales()">
                    </div>
                    <div class="form-field">
                        <label for="hora">Hora de salida:</label>
                        <input type="time" id="hora" required onchange="validarDatosGenerales()">
                    </div>

                    
                    <div class="form-field">
                        <label for="origenSelect">Seleccionar sucursal de origen:</label>
                        <select id="origenSelect" required onchange="cargarDestinos(this.value)">
                            <option value="">-- Seleccione el destino de origen --</option>
                              {% for fila in sucursal_origen %}
                            <option value="{{fila.sucursal_origen_id}}" 
                                    data-lat="{{fila.latitud}}" 
                                    data-lng="{{fila.longitud}}">{{fila.nombre}}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="form-field">
                        <label for="destinoSelect">Seleccionar sucursal de destino:</label>
                        <select id="destinoSelect" required disabled onchange="validarDatosGenerales()">
                            <option value="">-- Primero seleccione un origen --</option>
                        </select>
                    </div>

                </div>
                
                <div class="alert alert-info" id="alertaDatosGenerales">
                    <i class="fa-solid fa-info-circle"></i>
                    Complete todos los datos generales para habilitar la configuración de la salida.
                </div>
            </div>
        </div>

        <!-- Sistema de Pestañas -->
        <div class="tabs-container disabled" id="tabsContainer">
            <div class="tabs-nav">
                <button class="tab-btn active" onclick="openTab(event, 'tab-vehiculo')">
                    <i class="fa-solid fa-truck"></i>
                    Unidad
                </button>
                <button class="tab-btn" onclick="openTab(event, 'tab-empleados')">
                    <i class="fa-solid fa-users"></i>
                    Empleados
                </button>
                <button class="tab-btn" onclick="openTab(event, 'tab-escalas')">
                    <i class="fa-solid fa-route"></i>
                    Escalas
                </button>
                <button class="tab-btn" onclick="openTab(event, 'tab-paquetes')">
                    <i class="fa-solid fa-boxes-stacked"></i>
                    Paquetes
                </button>
                <!---
                <button class="tab-btn" onclick="openTab(event, 'tab-recojos')">
                    <i class="fa-solid fa-house"></i>
                    Recojos
                </button>-->

            </div>

            <!-- Contenido Pestaña: Vehículo -->
            <!-- Contenido Pestaña: Vehículo MODIFICADO -->
<div id="tab-vehiculo" class="tab-content active">
    <div class="section">
        <h2 class="section-title">🚚 Selección de unidad</h2>
        <div class="alert alert-error" id="errorVehiculo"></div>
        
        <!-- Tabla de vehículos (se oculta al seleccionar) -->
        <table id="vehiculosTabla">
            <thead>
                <tr>
                    <th>Vehículo</th>
                    <th>Capacidad Máxima (kg)</th>
                    <th>Capacidad Usada (kg)</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>

        <!-- Vehículo seleccionado (se muestra al seleccionar) -->
        <div class="assigned-items" id="vehiculoSeleccionado" style="display: none;">
            <div id="vehiculoInfo">
                <!-- El contenido se genera dinámicamente -->
            </div>
            
            <!-- Barra de capacidad básica (se mantiene para compatibilidad) -->
            <div class="capacity-bar" style="margin-top: 10px; display: none;">
                <div id="capacityFill" class="capacity-fill" style="width: 0%"></div>
            </div>
            <div id="capacityText" style="margin-top: 5px; font-size: 0.9rem; color: #666; display: none;">0 kg / 0 kg (0%)</div>
        </div>
        
        <!-- Control de capacidad por tramos (se genera dinámicamente) -->
        <div id="controlCapacidadTramos" class="control-capacidad-tramos" style="display: none;">
            <!-- El contenido se genera dinámicamente con JavaScript -->
        </div>
    </div>
</div>

            <!-- Contenido Pestaña: Empleados -->
            <div id="tab-empleados" class="tab-content">
                <div class="section">
                    <h2 class="section-title">👥 Gestión de Empleados</h2>
                    
                    <table id="empleadosTabla">
                        <thead>
                            <tr>
                                <th>Empleado</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>

                    <div class="assigned-items">
                        <h4>👥 Empleados Asignados:</h4>
                        <div id="empleadosAsignados">
                            <span style="color: #666; font-style: italic;">No hay empleados asignados</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Contenido Pestaña: Paquetes -->
            <div id="tab-paquetes" class="tab-content">
                <div class="section">
                    <h2 class="section-title">📦 Gestión de Paquetes</h2>
                    <div class="alert alert-error" id="errorPaquetes"></div>
                    
                    <div class="alert alert-info" id="infoPaquetes">
                        <i class="fa-solid fa-info-circle"></i>
                        Los paquetes se cargarán automáticamente según el origen y destino seleccionados.
                    </div>
                    
                    <table id="paquetesTabla">
                        <thead>
                            <tr>
                                <th>Tracking</th>
                                <th>Descripción</th>
                                <th>Peso (kg)</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>

                    <div class="assigned-items">
                        <h4>📦 Paquetes Asignados:</h4>
                        <div id="paquetesAsignados">
                            <span style="color: #666; font-style: italic;">No hay paquetes asignados</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Contenido Pestaña: Escalas -->
            <div id="tab-escalas" class="tab-content">
                <div class="section">
                    <h2 class="section-title">🗺️ Escalas de ruta</h2>

                    <div class="escalas-container">
                        <h4>📍 Escalas programadas (<span id="contadorEscalas">0</span>/5):</h4>
                        <div id="escalasLista">
                            <span style="color: #666; font-style: italic;">No hay escalas programadas</span>
                        </div>
                    </div>

                    <div class="mapa-container col">
                        <div id="map" class="mt-3" style="height: 400px;">

                        </div>
                    </div>

                </div>
            </div>

            <!-- Contenido Pestaña: Recojos 
            <div id="tab-recojos" class="tab-content">
                <div class="section">
                    <h2 class="section-title">🏠 Recojos en casa</h2>
                    <div class="checkbox-group">
                        <input type="checkbox" id="recojoCheckbox" onchange="toggleRecojoSection()">
                        <label for="recojoCheckbox">¿Incluir recojos en casa?</label>
                    </div>
                    
                    <div class="recojo-section" id="recojoSection">
                        <h4 style="color: #f39c12; margin-bottom: 15px;">📋 Transacciones disponibles para recojo:</h4>
                        <div id="transaccionesRecojo">
                        </div>
                        
                        <div class="assigned-items" style="margin-top: 20px;">
                            <h4>🏠 Recojos seleccionados:</h4>
                            <div id="recojosAsignados">
                                <span style="color: #666; font-style: italic;">No hay recojos seleccionados</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>-->

        </div>

        <!-- Botón Guardar -->
        <div class="save-section">
            <button class="btn btn-success" onclick="guardarSalida()" disabled id="btnGuardar">
                Guardar salida
            </button>
            <div class="alert" id="mensajeGuardado" style="margin-top: 15px;"></div>
        </div>
    </div>
{% endblock contenido %}


{% block scripts %}
<script>
 const vehiculos = {{ unidades | tojson }};
 const sucursalesOrigen = {{ sucursal_origen | tojson }};
 const empleados = {{ empleados | tojson }};
 const agencias = {{ agencias | tojson }};
 const paquetes = {{ paquetes | tojson }};
 const transaccionesRecojo = {{ recojo_casa | tojson }};
// Variables globales
let escalas = [];
let map;
let rutaLayer = null;
let agenciaMarkers = [];
let escalasMarkers = [];
let origenMarker = null;
let destinoMarker = null;
const MAX_ESCALAS = 5;

// Variables para almacenar datos seleccionados
let origenSeleccionado = null;
let destinoSeleccionado = null;
let destinosDisponibles = [];

// Función para inicializar el mapa
function inicializarMapa() {
    if (map) return; // Ya está inicializado
    
    map = L.map('map').setView([-6.77, -79.84], 6);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);
}




// Variables de estado
let vehiculoSeleccionado = null;
let empleadosAsignados = [];
let paquetesAsignados = [];
let recojosAsignados = [];
let pesoTotal = 0;

// Función para cargar destinos según origen seleccionado
async function cargarDestinos(sucursal_origen_id) {
    try {
        if (!sucursal_origen_id) {
            const destinoSelect = document.getElementById('destinoSelect');
            destinoSelect.innerHTML = '<option value="">-- Primero seleccione un origen --</option>';
            destinoSelect.disabled = true;
            return;
        }

        const response = await fetch('/sucursales_destino_api', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ sucursal_origen_id: sucursal_origen_id })
        });

        const data = await response.json();
        
        if (data.status === 1) {
            destinosDisponibles = data.data;
            updateSelect('destinoSelect', data.data, 'nombre', '-- Seleccione el destino final --', 'sucursal_destino_id');
            document.getElementById('destinoSelect').disabled = false;
            
            // Guardar datos del origen seleccionado
            const origenSelect = document.getElementById('origenSelect');
            const selectedOption = origenSelect.options[origenSelect.selectedIndex];
            origenSeleccionado = {
                id: sucursal_origen_id,
                nombre: selectedOption.text,
                lat: parseFloat(selectedOption.dataset.lat),
                lng: parseFloat(selectedOption.dataset.lng)
            };
            
            console.log('Origen seleccionado:', origenSeleccionado);
            
        } else {
            showAlert('mensajeGuardado', 'Error al cargar destinos: ' + data.msg, 'error');
        }
    } catch (error) {
        console.error('Error cargando destinos:', error);
        showAlert('mensajeGuardado', 'Error de conexión al cargar destinos', 'error');
    }
}

// Función para actualizar un select
function updateSelect(selectId, data, textField, placeholder, valueField = null) {
    const select = document.getElementById(selectId);
    if (!select) return;

    select.innerHTML = `<option value="">${placeholder}</option>`;

    if (data && Array.isArray(data)) {
        data.forEach(item => {
            const value = valueField ? item[valueField] : item[textField];
            const text = item[textField];
            const option = new Option(text, value);
            
            // Agregar data attributes para latitud y longitud si están disponibles
            if (item.latitud && item.longitud) {
                option.dataset.lat = item.latitud;
                option.dataset.lng = item.longitud;
            }
            
            select.appendChild(option);
        });
    }
}

// Función para validar datos generales y habilitar pestañas
function validarDatosGenerales() {
    const fecha = document.getElementById('fecha').value;
    const hora = document.getElementById('hora').value;
    const origen = document.getElementById('origenSelect').value;
    const destino = document.getElementById('destinoSelect').value;
    
    const tabsContainer = document.getElementById('tabsContainer');
    const alertaDatos = document.getElementById('alertaDatosGenerales');
    const btnGuardar = document.getElementById('btnGuardar');
    
    // Contar campos completados
    const camposCompletos = [fecha, hora, origen, destino].filter(campo => campo).length;
    const totalCampos = 4;
    
    // Actualizar mensaje de alerta con progreso
    if (camposCompletos === totalCampos) {
        // Todos los datos están completos
        tabsContainer.classList.remove('disabled');
        alertaDatos.style.display = 'none';
        btnGuardar.disabled = false;
        
        // Guardar datos del destino seleccionado
        const destinoSelect = document.getElementById('destinoSelect');
        const selectedDestino = destinoSelect.options[destinoSelect.selectedIndex];
        
        if (selectedDestino.dataset.lat && selectedDestino.dataset.lng) {
            destinoSeleccionado = {
                id: destino,
                nombre: selectedDestino.text,
                lat: parseFloat(selectedDestino.dataset.lat),
                lng: parseFloat(selectedDestino.dataset.lng)
            };
        } else {
            // Buscar en destinosDisponibles
            const destinoData = destinosDisponibles.find(d => d.sucursal_destino_id == destino);
            if (destinoData) {
                destinoSeleccionado = {
                    id: destino,
                    nombre: destinoData.nombre,
                    lat: parseFloat(destinoData.latitud),
                    lng: parseFloat(destinoData.longitud)
                };
            }
        }
        
        console.log('Destino seleccionado:', destinoSeleccionado);
        
        // Cargar paquetes para esta ruta
        cargarPaquetesParaRuta();
        
        // Actualizar mapa con origen y destino
        if (map) {
            actualizarMapaConRutaPrincipal();
        }
        
    } else {
        // Faltan datos - mostrar progreso
        tabsContainer.classList.add('disabled');
        alertaDatos.style.display = 'block';
        btnGuardar.disabled = true;
        
        // Mensaje dinámico según el progreso
        let mensaje = `Complete todos los datos generales para continuar (${camposCompletos}/${totalCampos}): `;
        const faltantes = [];
        
        if (!fecha) faltantes.push('Fecha de salida');
        if (!hora) faltantes.push('Hora de salida');
        if (!origen) faltantes.push('Origen');
        if (!destino) faltantes.push('Destino final');
        
        mensaje += faltantes.join(', ');
        
        alertaDatos.innerHTML = `
            <i class="fa-solid fa-info-circle"></i>
            ${mensaje}
            <div style="background: #fff; border-radius: 10px; margin-top: 8px; overflow: hidden;">
                <div style="background: #28a745; height: 4px; width: ${(camposCompletos/totalCampos)*100}%; transition: width 0.3s ease;"></div>
            </div>
        `;
    }
}



function crearIndicePaquetes() {
    if (!paquetes || !Array.isArray(paquetes)) return {};
    
    const indice = {
        porOrigen: {},
        porDestino: {},
        porRuta: {}
    };
    
    paquetes.forEach(paquete => {
        const origen = parseInt(paquete.id_sucursal_origen);
        const destino = parseInt(paquete.sucursal_destino_id);
        
        // Índice por origen
        if (!indice.porOrigen[origen]) indice.porOrigen[origen] = [];
        indice.porOrigen[origen].push(paquete);
        
        // Índice por destino
        if (!indice.porDestino[destino]) indice.porDestino[destino] = [];
        indice.porDestino[destino].push(paquete);
        
        // Índice por ruta (origen-destino)
        const claveRuta = `${origen}-${destino}`;
        if (!indice.porRuta[claveRuta]) indice.porRuta[claveRuta] = [];
        indice.porRuta[claveRuta].push(paquete);
    });
    
    return indice;
}


// Función para actualizar mapa con ruta principal
function actualizarMapaConRutaPrincipal() {
    if (!map || !origenSeleccionado || !destinoSeleccionado) return;
    
    // Limpiar marcadores de origen y destino anteriores
    if (origenMarker) {
        map.removeLayer(origenMarker);
    }
    if (destinoMarker) {
        map.removeLayer(destinoMarker);
    }
    
    // Crear marcador de origen
    origenMarker = L.marker([origenSeleccionado.lat, origenSeleccionado.lng], {
        icon: L.divIcon({
            className: 'marker-numero marker-origen',
            html: `<div class="marker-numero marker-origen">O</div>`,
            iconSize: [30, 30],
            iconAnchor: [15, 15]
        })
    }).addTo(map);
    
    origenMarker.bindPopup(`
        <strong>🚀 ORIGEN</strong><br>
        ${origenSeleccionado.nombre}
    `);
    
    // Crear marcador de destino
    destinoMarker = L.marker([destinoSeleccionado.lat, destinoSeleccionado.lng], {
        icon: L.divIcon({
            className: 'marker-numero marker-destino',
            html: `<div class="marker-numero marker-destino">D</div>`,
            iconSize: [30, 30],
            iconAnchor: [15, 15]
        })
    }).addTo(map);
    
    destinoMarker.bindPopup(`
        <strong>🎯 DESTINO FINAL</strong><br>
        ${destinoSeleccionado.nombre}
    `);
    
    // Actualizar vista del mapa para incluir origen y destino
    actualizarRutaEnMapa();
}

// Función para cambiar pestañas
function openTab(evt, tabName) {
    var i, tabcontent, tablinks;
    
    // Ocultar todo el contenido de pestañas
    tabcontent = document.getElementsByClassName("tab-content");
    for (i = 0; i < tabcontent.length; i++) {
        tabcontent[i].classList.remove("active");
    }
    
    // Remover la clase activa de todos los botones de pestañas
    tablinks = document.getElementsByClassName("tab-btn");
    for (i = 0; i < tablinks.length; i++) {
        tablinks[i].classList.remove("active");
    }
    
    // Mostrar la pestaña actual y marcar el botón como activo
    document.getElementById(tabName).classList.add("active");
    evt.currentTarget.classList.add("active");

    // Inicializar mapa cuando se abre la pestaña de escalas
    if (tabName === 'tab-escalas') {
        setTimeout(() => {
            inicializarMapa();
            if (map) {
                map.invalidateSize();
                mostrarAgenciasEnMapa();
                actualizarMapaConRutaPrincipal();
                actualizarRutaEnMapa();
            }
        }, 100);
    }
}

// Inicializar la aplicación
document.addEventListener('DOMContentLoaded', function() {
    configurarFechaHoraMinimas();
    
    renderizarVehiculos();
    renderizarEmpleados();
    renderizarPaquetes();
    actualizarContadorEscalas();
    
    // Inicializar variable global para paquetes
    window.paquetesDisponibles = [];
     setTimeout(() => {
        verificarDatosPaquetes();
    }, 1000);

    window.indicePaquetes = crearIndicePaquetes();
    
    console.log('📊 Índice de paquetes creado:', {
        origenes: Object.keys(window.indicePaquetes.porOrigen).length,
        destinos: Object.keys(window.indicePaquetes.porDestino).length,
        rutas: Object.keys(window.indicePaquetes.porRuta).length
    });

});



// Función para configurar fecha y hora mínimas
function configurarFechaHoraMinimas() {
    const ahora = new Date();
    const fechaInput = document.getElementById('fecha');
    const horaInput = document.getElementById('hora');
    
    // Configurar fecha mínima (hoy)
    const fechaHoy = ahora.toISOString().split('T')[0];
    fechaInput.min = fechaHoy;
    fechaInput.value = fechaHoy;
    
    // Configurar hora mínima si es hoy
    const horaActual = ahora.toTimeString().split(' ')[0].substring(0, 5);
    horaInput.value = horaActual;
    
    // Event listener para validar fecha
    fechaInput.addEventListener('change', function() {
        validarFechaHora();
    });
    
    // Event listener para validar hora
    horaInput.addEventListener('change', function() {
        validarFechaHora();
    });
    
    // Validación inicial
    validarFechaHora();
}

// Función para validar fecha y hora
function validarFechaHora() {
    const fechaInput = document.getElementById('fecha');
    const horaInput = document.getElementById('hora');
    const ahora = new Date();
    
    const fechaSeleccionada = new Date(fechaInput.value);
    const fechaHoy = new Date();
    fechaHoy.setHours(0, 0, 0, 0); // Resetear hora para comparar solo fechas
    
    // Si la fecha seleccionada es hoy
    if (fechaSeleccionada.getTime() === fechaHoy.getTime()) {
        // Configurar hora mínima como la actual + 30 minutos
        const horaMinima = new Date();
        horaMinima.setMinutes(horaMinima.getMinutes() + 30);
        const horaMinStr = horaMinima.toTimeString().split(' ')[0].substring(0, 5);
        
        horaInput.min = horaMinStr;
        
        // Si la hora actual es menor que la mínima, ajustarla
        if (horaInput.value < horaMinStr) {
            horaInput.value = horaMinStr;
            showAlert('mensajeGuardado', 'La hora de salida debe ser al menos 30 minutos después de la hora actual', 'warning');
        }
    } else {
        // Si es una fecha futura, no hay restricción de hora
        horaInput.min = '00:00';
    }
    
    // Validar que la fecha no sea pasada
    if (fechaSeleccionada < fechaHoy) {
        fechaInput.value = fechaHoy.toISOString().split('T')[0];
        showAlert('mensajeGuardado', 'No se puede seleccionar una fecha pasada', 'error');
    }
    
    validarDatosGenerales();
}


function renderizarVehiculos() {
    const tbody = document.querySelector('#vehiculosTabla tbody');
    tbody.innerHTML = vehiculos.map(vehiculo => {
        // Conversión segura
        const capacidad = Number(vehiculo.capacidad);
        let capacidadUsada = Number(vehiculo.capacidad_usada);

        if (vehiculo.unidadid === vehiculoSeleccionado) {
            capacidadUsada = paquetesAsignados.length === 0 
                ? Number(vehiculo.capacidad_usada) 
                : pesoTotal;
        }

        const porcentaje = capacidad > 0 ? (capacidadUsada / capacidad) * 100 : 0;
        const isSelected = vehiculoSeleccionado === vehiculo.unidadid;

        return `
            <tr class="vehicle-row ${isSelected ? 'selected' : ''}" onclick="seleccionarVehiculo(${vehiculo.unidadid})">
                <td>${vehiculo.nombre_unidad}</td>
                <td>${capacidad.toFixed(2)}</td>
                <td>
                    <div class="capacity-bar">
                        <div class="capacity-fill ${porcentaje >= 90 ? 'danger' : porcentaje >= 70 ? 'warning' : ''}" 
                            style="width: ${Math.min(porcentaje, 100)}%"></div>
                    </div>
                    ${capacidadUsada.toFixed(2)} / ${capacidad.toFixed(2)} kg (${porcentaje.toFixed(1)}%)
                </td>
            </tr>
        `;
    }).join('');
}

function renderizarEmpleados() {
    const tbody = document.querySelector('#empleadosTabla tbody');
    tbody.innerHTML = empleados.map(empleado => {
        const yaAsignado = empleadosAsignados.some(e => e.id === empleado.id);
        
        return `
            <tr class="employee-row ${yaAsignado ? 'selected' : ''}" 
                onclick="toggleEmpleado(${empleado.id})">
                <td>${empleado.nombre}</td>
            </tr>
        `;
    }).join('');
}

function togglePaquete(paqueteId) {
    if (!vehiculoSeleccionado) {
        showAlert('errorPaquetes', 'Debe seleccionar un vehículo antes de agregar paquetes', 'error');
        return;
    }

    // Buscar el paquete por su tracking
    const paquete = (window.paquetesDisponibles || []).find(p => p.tracking === paqueteId);
    if (!paquete) {
        console.warn(`⚠️ Paquete con ID ${paqueteId} no encontrado`);
        return;
    }

    // Verificar si ya está asignado
    const index = paquetesAsignados.findIndex(p => p.tracking === paqueteId);

    const vehiculo = vehiculos.find(v => v.unidadid == vehiculoSeleccionado);
    if (!vehiculo) {
        console.warn('⚠️ Vehículo no encontrado');
        return;
    }

    if (index === -1) {
        // Validar si puede agregarse
        const validacion = puedeAgregarPaquete(
            paquete, 
            paquetesAsignados, 
            vehiculo.capacidad,
            origenSeleccionado,
            destinoSeleccionado,
            escalas
        );
        
        if (!validacion.puedeAgregar) {
            showAlert('errorPaquetes', `No se puede agregar el paquete: ${validacion.razon}`, 'error');
            return;
        }

        // Agregar paquete
        paquetesAsignados.push(paquete);
        pesoTotal += parseFloat(paquete.peso);
    } else {
        // Quitar paquete
        pesoTotal -= parseFloat(paquete.peso);
        paquetesAsignados.splice(index, 1);
    }

    actualizarPaquetesAsignados();
    actualizarCapacidadVehiculo();
    renderizarPaquetes();
    hideAlert('errorPaquetes');
    actualizarControlCapacidadTramos(); // Tramos actualizados
}


function renderizarPaquetes() {
    const tbody = document.querySelector('#paquetesTabla tbody');
    
    // ✅ CORREGIDO: Primero obtener paquetes disponibles
    if (!window.paquetesDisponibles) {
        window.paquetesDisponibles = obtenerPaquetesParaRuta();
    }
    
    // Verificar si hay paquetes disponibles
    if (!window.paquetesDisponibles || window.paquetesDisponibles.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="3" style="text-align: center; color: #666; font-style: italic;">
                    No hay paquetes disponibles para esta ruta
                </td>
            </tr>
        `;
        return;
    }
    
    tbody.innerHTML = window.paquetesDisponibles.map(paquete => {
        const yaAsignado = paquetesAsignados.some(p => p.id === paquete.id);
        
        // Colores por tipo
        let colorTipo = '#ecf0f1';
        let iconoTipo = '📦';
        
        switch(paquete.tipo) {
            case 'largo_recorrido':
                colorTipo = '#e8f5e8'; // Verde claro
                iconoTipo = '🚀';
                break;
            case 'entrega_intermedia':
                colorTipo = '#fff3cd'; // Amarillo claro
                iconoTipo = '📤';
                break;
            case 'recojo_intermedio':
                colorTipo = '#cce5ff'; // Azul claro
                iconoTipo = '📥';
                break;
            case 'entre_escalas':
                colorTipo = '#f8d7da'; // Rosa claro
                iconoTipo = '🔄';
                break;
        }
        
        return `
            <tr class="package-row ${yaAsignado ? 'selected' : ''}" onclick="togglePaquete(${paquete.tracking})">
                <td>
                    <strong style="color: #2c3e50;">${paquete.tracking}</strong>
                </td>
                <td>
                    <div style="background: ${colorTipo}; padding: 4px 8px; border-radius: 5px; margin-bottom: 4px;">
                        ${iconoTipo} ${paquete.descripcion}
                    </div>
                    <small style="color: #666;">Tipo: ${paquete.tipo.replace(/_/g, ' ')}</small>
                </td>
                <td>
                    <span style="background: #ecf0f1; padding: 4px 8px; border-radius: 8px; font-weight: 600;">
                        ${paquete.peso} kg
                    </span>
                </td>
            </tr>
        `;
    }).join('');
}

// ========================================
// FUNCIÓN MEJORADA: cargarPaquetesParaRuta()
// ========================================

async function cargarPaquetesParaRuta() {
    if (!origenSeleccionado || !destinoSeleccionado) {
        console.log('⚠️ No hay origen o destino seleccionado');
        window.paquetesDisponibles = [];
        renderizarPaquetes();
        actualizarInfoPaquetes();
        return;
    }
    
    try {
        console.log('🔄 Filtrando paquetes para la ruta...');
        console.log(`📍 Ruta: ${origenSeleccionado.nombre.split(' / ')[0]} → ${destinoSeleccionado.nombre.split(' / ')[0]}`);
        
        if (escalas.length > 0) {
            console.log(`📍 Escalas: ${escalas.map(e => e.nombre.split(' / ')[0]).join(' → ')}`);
        }
        
        // ✅ Filtrar paquetes usando los datos ya cargados
        const paquetesParaRuta = obtenerPaquetesParaRuta();
        
        // ✅ Actualizar variable global
        window.paquetesDisponibles = paquetesParaRuta;
        
        console.log(`📦 Resultado: ${paquetesParaRuta.length} paquetes disponibles`);
        
        // ✅ Actualizar interfaz
        renderizarPaquetes();
        actualizarInfoPaquetes(paquetesParaRuta);
        
    } catch (error) {
        console.error('❌ Error filtrando paquetes:', error);
        window.paquetesDisponibles = [];
        renderizarPaquetes();
        actualizarInfoPaquetes([]);
    }
}

// Función auxiliar para actualizar info de paquetes
function actualizarInfoPaquetes(paquetesParaRuta = []) {
    const infoElement = document.getElementById('infoPaquetes');
    if (!infoElement) return;
    
    if (paquetesParaRuta.length === 0) {
        infoElement.innerHTML = `
            <i class="fa-solid fa-info-circle"></i>
            No hay paquetes disponibles para la ruta seleccionada.
        `;
        infoElement.className = 'alert alert-warning';
    } else {
        // Crear resumen por tipo
        const resumenTipos = paquetesParaRuta.reduce((acc, paquete) => {
            const tipoLegible = paquete.tipo.replace(/_/g, ' ');
            acc[tipoLegible] = (acc[tipoLegible] || 0) + 1;
            return acc;
        }, {});
        
        const pesoTotal = paquetesParaRuta.reduce((sum, p) => sum + p.peso, 0);
        
        const resumenTexto = Object.entries(resumenTipos)
            .map(([tipo, cantidad]) => `${tipo}: ${cantidad}`)
            .join(', ');
        
        infoElement.innerHTML = `
            <i class="fa-solid fa-check-circle"></i>
            <strong>${paquetesParaRuta.length} paquetes disponibles</strong> 
            (${pesoTotal.toFixed(1)}kg total)<br>
            <small style="color: #666;">${resumenTexto}</small>
        `;
        infoElement.className = 'alert alert-info';
    }
}


// Actualizar la función validarDatosGenerales() para incluir la carga de paquetes
function validarDatosGenerales() {
    const fecha = document.getElementById('fecha').value;
    const hora = document.getElementById('hora').value;
    const origen = document.getElementById('origenSelect').value;
    const destino = document.getElementById('destinoSelect').value;
    
    const tabsContainer = document.getElementById('tabsContainer');
    const alertaDatos = document.getElementById('alertaDatosGenerales');
    const btnGuardar = document.getElementById('btnGuardar');
    
    const camposCompletos = [fecha, hora, origen, destino].filter(campo => campo).length;
    const totalCampos = 4;
    
    if (camposCompletos === totalCampos) {
        // Todos los datos están completos
        tabsContainer.classList.remove('disabled');
        alertaDatos.style.display = 'none';
        btnGuardar.disabled = false;
        
        // Guardar datos del destino seleccionado
        const destinoSelect = document.getElementById('destinoSelect');
        const selectedDestino = destinoSelect.options[destinoSelect.selectedIndex];
        
        if (selectedDestino.dataset.lat && selectedDestino.dataset.lng) {
            destinoSeleccionado = {
                id: destino,
                nombre: selectedDestino.text,
                lat: parseFloat(selectedDestino.dataset.lat),
                lng: parseFloat(selectedDestino.dataset.lng)
            };
        } else {
            const destinoData = destinosDisponibles.find(d => d.sucursal_destino_id == destino);
            if (destinoData) {
                destinoSeleccionado = {
                    id: destino,
                    nombre: destinoData.nombre,
                    lat: parseFloat(destinoData.latitud),
                    lng: parseFloat(destinoData.longitud)
                };
            }
        }
        
        console.log('✅ Origen:', origenSeleccionado);
        console.log('✅ Destino:', destinoSeleccionado);
        
        // ✅ CORREGIDO: Cargar paquetes para esta ruta
        cargarPaquetesParaRuta();
        
        // Actualizar mapa
        if (map) {
            actualizarMapaConRutaPrincipal();
        }
        
    } else {
        // Faltan datos
        tabsContainer.classList.add('disabled');
        alertaDatos.style.display = 'block';
        btnGuardar.disabled = true;
        
        
        // Mensaje dinámico
        let mensaje = `Complete todos los datos generales para continuar (${camposCompletos}/${totalCampos}): `;
        const faltantes = [];
        
        if (!fecha) faltantes.push('Fecha de salida');
        if (!hora) faltantes.push('Hora de salida');
        if (!origen) faltantes.push('Origen');
        if (!destino) faltantes.push('Destino final');
        
        mensaje += faltantes.join(', ');
        
        alertaDatos.innerHTML = `
            <i class="fa-solid fa-info-circle"></i>
            ${mensaje}
            <div style="background: #fff; border-radius: 10px; margin-top: 8px; overflow: hidden;">
                <div style="background: #28a745; height: 4px; width: ${(camposCompletos/totalCampos)*100}%; transition: width 0.3s ease;"></div>
            </div>
        `;
    }
}


function verificarDatosPaquetes() {
    console.log('🔍 Verificando estructura de datos...');
    
    if (!paquetes || !Array.isArray(paquetes)) {
        console.error('❌ La variable paquetes no existe o no es un array');
        return false;
    }
    
    console.log(`📊 Total paquetes cargados: ${paquetes.length}`);
    
    // Verificar que cada paquete tenga los campos obligatorios
    const erroresEncontrados = [];
    
    paquetes.forEach((paquete, index) => {
        const errores = [];
        
        if (!paquete.tracking) errores.push('Falta tracking');
        if (typeof paquete.peso !== 'number' && !paquete.peso) errores.push('Falta peso');
        if (!paquete.id_sucursal_origen) errores.push('Falta id_sucursal_origen');
        if (!paquete.sucursal_destino_id) errores.push('Falta sucursal_destino_id');
        
        if (errores.length > 0) {
            erroresEncontrados.push(`Paquete ${index}: ${errores.join(', ')}`);
            console.error(`❌ Paquete ${index}:`, errores, paquete);
        }
    });
    
    if (erroresEncontrados.length === 0) {
        console.log('✅ Todos los paquetes tienen la estructura correcta');
        
        // Mostrar ejemplo de paquete
        if (paquetes.length > 0) {
            console.log('📋 Ejemplo de paquete:', paquetes[0]);
        }
        
        return true;
    } else {
        console.error('❌ Errores encontrados:', erroresEncontrados);
        return false;
    }
}



function seleccionarVehiculo(vehiculoId) {
    vehiculoSeleccionado = vehiculoId;
    const vehiculo = vehiculos.find(v => v.unidadid === vehiculoId);
    
    // Mostrar solo el vehículo seleccionado
    mostrarVehiculoSeleccionado(vehiculo);
    
    // Actualizar capacidad inicial
    actualizarCapacidadVehiculo();
    
    // Ocultar errores
    hideAlert('errorVehiculo');
    
    // Actualizar control de capacidad por tramos
    actualizarControlCapacidadTramos();
}

function mostrarVehiculoSeleccionado(vehiculo) {
    // Ocultar la tabla de vehículos
    const tabla = document.getElementById('vehiculosTabla');
    tabla.style.display = 'none';
    
    // Mostrar el vehículo seleccionado
    const contenedorSeleccionado = document.getElementById('vehiculoSeleccionado');
    contenedorSeleccionado.style.display = 'block';
    
    // Actualizar información del vehículo
    document.getElementById('vehiculoInfo').innerHTML = `
        <div class="vehiculo-seleccionado-card">
            <div class="vehiculo-header">
                <span class="vehiculo-nombre">${vehiculo.nombre_unidad}</span>
                <span class="vehiculo-capacidad">Capacidad: ${vehiculo.capacidad} kg</span>
                <button class="btn-cambiar-vehiculo" onclick="cambiarVehiculo()">
                    <i class="fa-solid fa-exchange-alt"></i> Cambiar vehículo
                </button>
            </div>
        </div>
    `;
}

function cambiarVehiculo() {
    // Mostrar la tabla de vehículos nuevamente
    const tabla = document.getElementById('vehiculosTabla');
    tabla.style.display = 'table';
    
    // Ocultar el vehículo seleccionado
    const contenedorSeleccionado = document.getElementById('vehiculoSeleccionado');
    contenedorSeleccionado.style.display = 'none';
    
    // Limpiar selección
    vehiculoSeleccionado = null;
    
    // Limpiar paquetes asignados
    paquetesAsignados = [];
    pesoTotal = 0;
    actualizarPaquetesAsignados();
    
    // Ocultar control de tramos
    const controlTramos = document.getElementById('controlCapacidadTramos');
    if (controlTramos) {
        controlTramos.style.display = 'none';
    }
    
    // Re-renderizar tabla
    renderizarVehiculos();
}



function toggleEmpleado(empleadoId) {
    const empleado = empleados.find(e => e.id === empleadoId);
    const index = empleadosAsignados.findIndex(e => e.id === empleadoId);
    
    if (index === -1) {
        empleadosAsignados.push(empleado);
    } else {
        empleadosAsignados.splice(index, 1);
    }
    
    actualizarEmpleadosAsignados();
    renderizarEmpleados();
}




// ✅ 3. MEJORAR obtenerPaquetesParaRuta() CON VALIDACIÓN CORRECTA
function obtenerPaquetesParaRuta() {
    if (!origenSeleccionado || !destinoSeleccionado) {
        console.log('⚠️ No hay origen o destino seleccionado');
        return [];
    }
    
    // Crear ruta completa: [origen, escalas..., destino]
    const rutaCompleta = [
        { id: parseInt(origenSeleccionado.id), nombre: origenSeleccionado.nombre },
        ...escalas.map(escala => ({ id: escala.id, nombre: escala.nombre })),
        { id: parseInt(destinoSeleccionado.id), nombre: destinoSeleccionado.nombre }
    ];
    
    console.log('🗺️ Ruta completa:', rutaCompleta.map(r => r.nombre).join(' → '));
    
    // ✅ VALIDACIÓN MEJORADA: Verificar orden correcto
    const paquetesValidos = paquetes.filter(paquete => {
        const origenPaquete = parseInt(paquete.id_sucursal_origen);
        const destinoPaquete = parseInt(paquete.sucursal_destino_id);
        
        // Verificar que origen y destino sean diferentes
        if (origenPaquete === destinoPaquete) {
            return false;
        }
        
        // Encontrar índices en la ruta
        const indiceOrigen = rutaCompleta.findIndex(punto => punto.id === origenPaquete);
        const indiceDestino = rutaCompleta.findIndex(punto => punto.id === destinoPaquete);
        
        // Ambos puntos deben existir en la ruta
        if (indiceOrigen === -1 || indiceDestino === -1) {
            return false;
        }
        
        // ✅ CRÍTICO: El origen debe ser ANTERIOR al destino en la ruta
        if (indiceOrigen >= indiceDestino) {
            console.log(`❌ Paquete ${paquete.tracking}: Orden incorrecto (origen: ${indiceOrigen}, destino: ${indiceDestino})`);
            return false;
        }
        
        return true;
    });
    
    console.log(`📦 Paquetes válidos encontrados: ${paquetesValidos.length}/${paquetes.length}`);
    
    // Categorizar y enriquecer cada paquete
    const paquetesCategorizados = paquetesValidos.map(paquete => {
        const origenPaquete = parseInt(paquete.id_sucursal_origen);
        const destinoPaquete = parseInt(paquete.sucursal_destino_id);
        
        const indiceCarga = rutaCompleta.findIndex(punto => punto.id === origenPaquete);
        const indiceDescarga = rutaCompleta.findIndex(punto => punto.id === destinoPaquete);
        
        // Determinar tipo de paquete
        let tipo = 'entre_escalas';
        let descripcionRuta = '';
        let iconoTipo = '📦';
        
        const puntoOrigen = rutaCompleta[indiceCarga]?.nombre.split(' / ')[0] || 'Origen';
        const puntoDestino = rutaCompleta[indiceDescarga]?.nombre.split(' / ')[0] || 'Destino';
        
        if (indiceCarga === 0 && indiceDescarga === rutaCompleta.length - 1) {
            tipo = 'largo_recorrido';
            iconoTipo = '🚀';
            descripcionRuta = `${puntoOrigen} → ${puntoDestino} (Viaje completo)`;
        } else if (indiceCarga === 0) {
            tipo = 'entrega_intermedia';
            iconoTipo = '📤';
            descripcionRuta = `${puntoOrigen} → ${puntoDestino} (Entrega en escala)`;
        } else if (indiceDescarga === rutaCompleta.length - 1) {
            tipo = 'recojo_intermedio';
            iconoTipo = '📥';
            descripcionRuta = `${puntoOrigen} → ${puntoDestino} (Recojo en escala)`;
        } else {
            tipo = 'entre_escalas';
            iconoTipo = '🔄';
            descripcionRuta = `${puntoOrigen} → ${puntoDestino} (Entre escalas)`;
        }
        
        return {
            id: paquete.tracking,
            tracking: paquete.tracking,
            descripcion: descripcionRuta,
            peso: parseFloat(paquete.peso),
            punto_carga: indiceCarga,
            punto_descarga: indiceDescarga,
            tipo: tipo,
            origen_id: origenPaquete,
            destino_id: destinoPaquete,
            icono: iconoTipo,
            // ✅ NUEVO: Calcular tramos ocupados
            tramos_ocupados: calcularTramosOcupados(indiceCarga, indiceDescarga)
        };
    });
    
    // Estadísticas para debug
    const estadisticas = paquetesCategorizados.reduce((acc, paquete) => {
        acc[paquete.tipo] = (acc[paquete.tipo] || 0) + 1;
        return acc;
    }, {});
    
    console.log('📊 Estadísticas de paquetes:', estadisticas);
    
    return paquetesCategorizados;
}

function calcularTramosOcupados(indiceCarga, indiceDescarga) {
    const tramos = [];
    for (let i = indiceCarga; i < indiceDescarga; i++) {
        tramos.push(`${i}-${i + 1}`);
    }
    return tramos;
}

// ✅ 5. FUNCIÓN PARA VALIDAR TODO EL SISTEMA
function validarSistemaCompleto() {
    console.log('🔍 VALIDACIÓN COMPLETA DEL SISTEMA');
    console.log('================================');
    
    // 1. Verificar datos básicos
    console.log('1. Datos básicos:');
    console.log(`   - Origen: ${origenSeleccionado ? '✅' : '❌'} ${origenSeleccionado?.nombre || 'No seleccionado'}`);
    console.log(`   - Destino: ${destinoSeleccionado ? '✅' : '❌'} ${destinoSeleccionado?.nombre || 'No seleccionado'}`);
    console.log(`   - Escalas: ${escalas.length} configuradas`);
    console.log(`   - Vehículo: ${vehiculoSeleccionado ? '✅' : '❌'}`);
    console.log(`   - Empleados: ${empleadosAsignados.length} asignados`);
    console.log(`   - Paquetes: ${paquetesAsignados.length} asignados`);
    
    // 2. Verificar paquetes disponibles
    console.log('\n2. Paquetes disponibles:');
    const paquetesDisponibles = window.paquetesDisponibles || [];
    console.log(`   - Total disponibles: ${paquetesDisponibles.length}`);
    
    if (paquetesDisponibles.length > 0) {
        const tiposCounts = paquetesDisponibles.reduce((acc, p) => {
            acc[p.tipo] = (acc[p.tipo] || 0) + 1;
            return acc;
        }, {});
        console.log('   - Por tipo:', tiposCounts);
    }
    
    // 3. Verificar capacidad
    if (vehiculoSeleccionado && paquetesAsignados.length > 0) {
        console.log('\n3. Capacidad:');
        depurarCapacidadDetallada();
    }
    
    console.log('\n✅ Validación completa');
}


let capaRutas = null;

function dibujarRutaDesdeEscalas() {
    //ShowSpinner();

    if (escalas.length < 2) {
        toastr.warning("Debe haber al menos dos sucursales para dibujar la ruta.", 'MENSAJE DE SISTEMA');
        HideSpinner();
        return;
    }

    borrarRutasPrevias();

    const coordenadas = escalas.map(escala => {
        return {
            lat: escala.latitud,
            lng: escala.longitud
        };
    });

    let totalDistancia = 0;
    let totalDuracion = 0;
    let promesas = [];

    for (let i = 0; i < coordenadas.length - 1; i++) {
        const origen = coordenadas[i];
        const destino = coordenadas[i + 1];

        let promesa = axios.get('/API_ENRUTAR', {
            params: {
                start: `${origen.lat},${origen.lng}`,
                end: `${destino.lat},${destino.lng}`
            }
        }).then(response => {
            const datos = response.data;
            const ruta = datos.route;
            const resumen = datos;

            totalDistancia += resumen.distance;
            totalDuracion += resumen.duration;

            if (ruta && ruta.length > 0) {
                const latlngs = ruta.map(coord => [coord[1], coord[0]]);
                const lineaRuta = L.polyline(latlngs, { color: 'blue' }).addTo(capaRutas);

                const distanciaKm = (resumen.distance / 1000).toFixed(2);
                const duracionMin = (resumen.duration / 60).toFixed(2);

                escalas[i + 1]['distancia'] = (resumen.distance / 1000);
                escalas[i + 1]['tiempo'] = (resumen.duration / 60);

                lineaRuta.bindTooltip(`📍 ${distanciaKm} km - ⏱ ${duracionMin} min`, {
                    permanent: false,
                    direction: 'center',
                    offset: [0, -10],
                    opacity: 0.8,
                    className: 'tooltip-ruta'
                }).openTooltip();
            }
        }).catch(error => {
            toastr.error("Ocurrió un error inesperado al obtener la ruta");
            console.error('Error al obtener la ruta:', error);
            HideSpinner();
        });

        promesas.push(promesa);
    }

    Promise.all(promesas).then(() => {
        const km = formatearNumero((totalDistancia / 1000));
        const min = formatearNumero((totalDuracion / 60));
        document.getElementById('distanciaRuta').innerText = km;
        document.getElementById('tiempoRuta').innerText = min;

        reordenarTabla();
    }).finally(() => {
        HideSpinner();
    });
}


function togglePaquete(paqueteId) {
    if (!vehiculoSeleccionado) {
        showAlert('errorPaquetes', 'Debe seleccionar un vehículo antes de agregar paquetes', 'error');
        return;
    }

    const paquete = window.paquetesDisponibles.find(p => p.tracking === paqueteId);
    console.log(paquete)
    const vehiculo = vehiculos.find(v => v.unidadid === vehiculoSeleccionado);
    const index = paquetesAsignados.findIndex(p => p.tracking === paqueteId);

    
    if (index === -1) {
        const validacion = puedeAgregarPaquete(
            paquete, 
            paquetesAsignados, 
            vehiculo.capacidad,
            origenSeleccionado,
            destinoSeleccionado,
            escalas
        );
        
        if (!validacion.puedeAgregar) {
            showAlert('errorPaquetes', 
                `No se puede agregar el paquete: ${validacion.razon}`, 'error');
            return;
        }
        
        paquetesAsignados.push(paquete);
        pesoTotal += paquete.peso;
    } else {
        pesoTotal -= paquete.peso;
        paquetesAsignados.splice(index, 1);
    }
    
    actualizarPaquetesAsignados();
    actualizarCapacidadVehiculo();
    renderizarPaquetes();
    hideAlert('errorPaquetes');
    
    // Actualizar control de tramos
    actualizarControlCapacidadTramos();
}


function toggleRecojoItem(transaccionId) {
    const transaccion = transaccionesRecojo.find(t => t.id === transaccionId);
    const index = recojosAsignados.findIndex(r => r.id === transaccionId);
    const checkbox = document.getElementById(`recojo_${transaccionId}`);
    const item = document.querySelector(`#recojo_${transaccionId}`).closest('.recojo-item');
    
    // if (index === -1) {
    //     recojosAsignados.push(transaccion);
    //     checkbox.checked = true;
    //     item.classList.add('selected');
    // } else {
    //     recojosAsignados.splice(index, 1);
    //     checkbox.checked = false;
    //     item.classList.remove('selected');
    // }
    
    actualizarRecojosAsignados();
}

function actualizarEmpleadosAsignados() {
    const contenedor = document.getElementById('empleadosAsignados');
    if (empleadosAsignados.length === 0) {
        contenedor.innerHTML = '<span style="color: #666; font-style: italic;">No hay empleados asignados</span>';
    } else {
        contenedor.innerHTML = empleadosAsignados.map(empleado => 
            `<span class="item-tag">
                ${empleado.nombre} 
                <button class="remove-btn" onclick="toggleEmpleado(${empleado.id})">×</button>
            </span>`
        ).join('');
    }
}

function actualizarPaquetesAsignados() {
    const contenedor = document.getElementById('paquetesAsignados');
    if (paquetesAsignados.length === 0) {
        contenedor.innerHTML = '<span style="color: #666; font-style: italic;">No hay paquetes asignados</span>';
    } else {
        contenedor.innerHTML = paquetesAsignados.map(paquete => 
            `<span class="item-tag">
                ${paquete.tracking} - ${paquete.peso}kg
                <button class="remove-btn" onclick="togglePaquete(${paquete.tracking})">×</button>
            </span>`
        ).join('');
    }
}

function actualizarRecojosAsignados() {
    const contenedor = document.getElementById('recojosAsignados');
    if (recojosAsignados.length === 0) {
        contenedor.innerHTML = '<span style="color: #666; font-style: italic;">No hay recojos seleccionados</span>';
    } else {
        contenedor.innerHTML = recojosAsignados.map(recojo => 
                            `<span class="item-tag">
                ${recojo.numeroTransaccion} - ${recojo.cliente}
                <button class="remove-btn" onclick="toggleRecojoItem(${recojo.id})">×</button>
            </span>`
        ).join('');
    }
}

function actualizarCapacidadVehiculo() {
    if (!vehiculoSeleccionado) return;

    const vehiculo = vehiculos.find(v => v.unidadid === vehiculoSeleccionado);
    const capacidad = Number(vehiculo.capacidad);

    // Si no hay paquetes asignados, usar lo que viene de backend
    const capacidadUsada = paquetesAsignados.length === 0 
        ? Number(vehiculo.capacidad_usada) 
        : pesoTotal;

    const porcentaje = capacidad > 0 ? (capacidadUsada / capacidad) * 100 : 0;

    document.getElementById('capacityText').textContent = 
        `${capacidadUsada.toFixed(2)} kg / ${capacidad.toFixed(2)} kg (${porcentaje.toFixed(1)}%)`;

    const fill = document.getElementById('capacityFill');
    fill.style.width = `${Math.min(porcentaje, 100)}%`;
    fill.className = 'capacity-fill';
    if (porcentaje >= 90) fill.classList.add('danger');
    else if (porcentaje >= 70) fill.classList.add('warning');
}


function puedeAgregarPaquete(paqueteNuevo, paquetesActuales, capacidadVehiculo, origenSeleccionado, destinoSeleccionado, escalas) {
    
    // 🔍 PASO 1: Verificaciones básicas
    if (!paqueteNuevo) {
        return {
            puedeAgregar: false,
            razon: 'Paquete no válido',
            alertas: [],
            tipo: 'error'
        };
    }
    
    if (!origenSeleccionado || !destinoSeleccionado) {
        return {
            puedeAgregar: false,
            razon: 'No hay ruta definida (falta origen o destino)',
            alertas: [],
            tipo: 'error'
        };
    }
    
    if (!capacidadVehiculo || capacidadVehiculo <= 0) {
        return {
            puedeAgregar: false,
            razon: 'Capacidad del vehículo no válida',
            alertas: [],
            tipo: 'error'
        };
    }
    
    // 🔍 PASO 2: Verificar que el paquete no esté ya asignado
    const yaAsignado = paquetesActuales.some(p => p.id === paqueteNuevo.id || p.tracking === paqueteNuevo.tracking);
    if (yaAsignado) {
        return {
            puedeAgregar: false,
            razon: 'Este paquete ya está asignado',
            alertas: [],
            tipo: 'warning'
        };
    }
    
    // 🔍 PASO 3: Crear la lista completa de paquetes (actuales + nuevo)
    const todosLosPaquetes = [...paquetesActuales, paqueteNuevo];
    
    // 🔍 PASO 4: Crear ruta completa para validación
    const rutaCompleta = crearRutaCompleta(origenSeleccionado, destinoSeleccionado, escalas);
    
    // 🔍 PASO 5: Validar capacidad por todos los tramos
    const validacionCapacidad = validarCapacidadPorTramos(todosLosPaquetes, rutaCompleta, capacidadVehiculo);
    
    // 🔍 PASO 6: Verificar el resultado
    if (!validacionCapacidad.esValido) {
        // Buscar el primer error crítico
        const errorPrincipal = validacionCapacidad.alertas.find(alerta => alerta.tipo === 'error');
        
        if (errorPrincipal) {
            return {
                puedeAgregar: false,
                razon: errorPrincipal.mensaje,
                alertas: validacionCapacidad.alertas,
                tipo: 'error',
                detalles: {
                    capacidadPorTramo: validacionCapacidad.capacidadPorTramo,
                    tramoProblematico: validacionCapacidad.tramoProblematico,
                    capacidadMaximaUsada: validacionCapacidad.capacidadMaximaUsada
                }
            };
        }
    }
    
    // 🔍 PASO 7: Verificar warnings (capacidad alta pero no crítica)
    const warnings = validacionCapacidad.alertas.filter(alerta => alerta.tipo === 'warning');
    
    // ✅ PASO 8: El paquete se puede agregar
    return {
        puedeAgregar: true,
        razon: 'El paquete se puede agregar sin problemas',
        alertas: warnings, // Incluir warnings si los hay
        tipo: warnings.length > 0 ? 'warning' : 'success',
        detalles: {
            pesoNuevoPaquete: paqueteNuevo.peso,
            pesoTotalActual: paquetesActuales.reduce((sum, p) => sum + p.peso, 0),
            pesoTotalNuevo: todosLosPaquetes.reduce((sum, p) => sum + p.peso, 0),
            capacidadPorTramo: validacionCapacidad.capacidadPorTramo,
            capacidadMaximaUsada: validacionCapacidad.capacidadMaximaUsada,
            porcentajeUsoMaximo: ((validacionCapacidad.capacidadMaximaUsada / capacidadVehiculo) * 100).toFixed(1)
        }
    };
}

// ========================================
// FUNCIONES PARA MANEJO DE ESCALAS
// ========================================

function mostrarAgenciasEnMapa() {
    if (!map) return;

    // Limpiar marcadores anteriores
    agenciaMarkers.forEach(marker => map.removeLayer(marker));
    agenciaMarkers = [];

    agencias.forEach(agencia => {
        if (agencia.lat && agencia.lng) {
            // Verificar si esta agencia ya está en escalas
            const yaEsEscala = escalas.some(escala => escala.id === agencia.id);
            
            // Verificar si es origen o destino
            const esOrigen = origenSeleccionado && agencia.id == origenSeleccionado.id;
            const esDestino = destinoSeleccionado && agencia.id == destinoSeleccionado.id;
            const esOrigenODestino = esOrigen || esDestino;
            
            const marker = L.marker([agencia.lat, agencia.lng]).addTo(map);
            
            // Crear popup dinámico
            let popupContent = `
                <strong>${agencia.nombre}</strong><br>
                📍 ${agencia.direccion}<br>
                📞 ${agencia.telefono || 'Sin teléfono'}<br>
                🕒 ${agencia.horario || 'Horario no disponible'}<br>
                📍 ${agencia.distrito}, ${agencia.provincia}<br>
            `;
            
            if (esOrigenODestino) {
                // Si es origen o destino, mostrar mensaje informativo
                popupContent += `
                    <div style="background: #e3f2fd; padding: 8px; border-radius: 5px; margin-top: 8px; font-size: 0.8rem; color: #1976d2;">
                        <i class="fa-solid fa-info-circle"></i>
                        ${esOrigen ? '🚀 Esta es su sucursal de ORIGEN' : '🎯 Esta es su sucursal de DESTINO'}
                    </div>
                `;
            } else if (yaEsEscala) {
                // Si ya es una escala, mostrar botón para quitar
                popupContent += `
                    <button onclick="eliminarEscalaDesdeMapa(${agencia.id})" class="btn-eliminar-escala">
                        ❌ Quitar escala
                    </button>
                `;
            } else {
                // Si no es origen, destino ni escala, mostrar botón para agregar
                popupContent += `
                    <button onclick="agregarEscalaDesdeMapa(${agencia.id})" class="btn-agregar-escala">
                        ➕ Agregar como escala
                    </button>
                `;
            }
            
            marker.bindPopup(popupContent);
            
            // Evento de doble clic solo si no es origen o destino
            if (!esOrigenODestino) {
                marker.on('dblclick', function() {
                    if (yaEsEscala) {
                        eliminarEscalaDesdeMapa(agencia.id);
                    } else {
                        agregarEscalaDesdeMapa(agencia.id);
                    }
                });
            }

            agenciaMarkers.push(marker);
        }
    });

    // Ajustar vista si hay marcadores
    if (agenciaMarkers.length > 0) {
        const group = new L.featureGroup(agenciaMarkers);
        map.fitBounds(group.getBounds().pad(0.1));
    }
}

function crearRutaCompleta(origen, destino, escalas) {
    const ruta = [
        { 
            id: parseInt(origen.id), 
            nombre: origen.nombre, 
            lat: origen.lat, 
            lng: origen.lng,
            orden: 0,
            tipo: 'origen'
        }
    ];
    
    // Agregar escalas con orden secuencial
    escalas.forEach((escala, index) => {
        ruta.push({
            id: parseInt(escala.id),
            nombre: escala.nombre,
            lat: escala.lat,
            lng: escala.lng,
            orden: index + 1,
            tipo: 'escala'
        });
    });
    
    // Agregar destino final
    ruta.push({
        id: parseInt(destino.id),
        nombre: destino.nombre,
        lat: destino.lat,
        lng: destino.lng,
        orden: escalas.length + 1,
        tipo: 'destino'
    });
    
    return ruta;
}

function actualizarControlCapacidadTramos() {
    if (!vehiculoSeleccionado || !origenSeleccionado || !destinoSeleccionado) {
        const control = document.getElementById('controlCapacidadTramos');
        if (control) {
            control.style.display = 'none';
        }
        return;
    }

    const vehiculo = vehiculos.find(v => v.unidadid === vehiculoSeleccionado);
    if (!vehiculo) return;

    // Crear ruta completa
    const rutaCompleta = crearRutaCompleta(origenSeleccionado, destinoSeleccionado, escalas);
    
    // Generar control de capacidad
    generarControlCapacidadHTML(vehiculo, rutaCompleta, paquetesAsignados);
}


/**
 * Genera las filas de la tabla de tramos
 */
function generarFilasTramos(rutaCompleta, capacidadPorTramos, capacidadMaxima) {
    let filasHTML = '';

    for (let i = 0; i < rutaCompleta.length - 1; i++) {
        const puntoOrigen = rutaCompleta[i];
        const puntoDestino = rutaCompleta[i + 1];
        const pesoTramo = capacidadPorTramos[i] || 0;
        const porcentajeTramo = (pesoTramo / capacidadMaxima) * 100;

        // Determinar estado del tramo
        let claseEstado = 'dentro-limite';
        let textoEstado = 'Normal';
        
        if (porcentajeTramo >= 100) {
            claseEstado = 'excede-limite';
            textoEstado = 'Sobrecarga';
        } else if (porcentajeTramo >= 80) {
            claseEstado = 'cerca-limite';
            textoEstado = 'Cerca del límite';
        }

        const nombreOrigen = puntoOrigen.nombre.split(' / ')[0] || puntoOrigen.nombre;
        const nombreDestino = puntoDestino.nombre.split(' / ')[0] || puntoDestino.nombre;

        filasHTML += `
            <div class="fila-tramo">
                <div class="columna-tramo">
                    <strong>${nombreOrigen} → ${nombreDestino}</strong>
                    <br>
                    <small style="color: #666;">Tramo ${i + 1}</small>
                </div>
                <div class="columna-peso">
                    <div class="peso-valor">${pesoTramo.toFixed(2)} kg</div>
                    <div class="barra-mini">
                        <div class="barra-mini-relleno ${claseEstado}" style="width: ${Math.min(porcentajeTramo, 100)}%"></div>
                    </div>
                    <div class="porcentaje">${porcentajeTramo.toFixed(1)}%</div>
                </div>
                <div class="columna-estado">
                    <div class="estado-badge ${claseEstado}">
                        ${textoEstado}
                    </div>
                </div>
            </div>
        `;
    }

    return filasHTML;
}

/**
 * Calcula la capacidad utilizada en cada tramo de la ruta
 */
function calcularCapacidadPorTramos(paquetesAsignados, rutaCompleta) {
    const capacidadPorTramo = {};

    // Inicializar todos los tramos con peso 0
    for (let i = 0; i < rutaCompleta.length - 1; i++) {
        capacidadPorTramo[i] = 0;
    }

    // Calcular peso por tramo
    paquetesAsignados.forEach(paquete => {
        if (paquete.tramos_ocupados && Array.isArray(paquete.tramos_ocupados)) {
            paquete.tramos_ocupados.forEach(tramoIndex => {
                if (typeof tramoIndex === 'number') {
                    capacidadPorTramo[tramoIndex] = (capacidadPorTramo[tramoIndex] || 0) + paquete.peso;
                }
            });
        } else {
            // Fallback: calcular tramos ocupados
            const tramosOcupados = calcularTramosOcupados(paquete.punto_carga, paquete.punto_descarga);
            tramosOcupados.forEach(tramoIndex => {
                capacidadPorTramo[tramoIndex] = (capacidadPorTramo[tramoIndex] || 0) + paquete.peso;
            });
        }
    });

    return capacidadPorTramo;
}

/**
 * Calcula qué tramos ocupa un paquete basado en sus puntos de carga y descarga
 */
function calcularTramosOcupados(indiceCarga, indiceDescarga) {
    const tramos = [];
    for (let i = indiceCarga; i < indiceDescarga; i++) {
        tramos.push(i);
    }
    return tramos;
}

/**
 * Valida la capacidad por todos los tramos de la ruta
 */
function validarCapacidadPorTramos(todosPaquetes, rutaCompleta, capacidadMaxima) {
    const capacidadPorTramo = calcularCapacidadPorTramos(todosPaquetes, rutaCompleta);
    const alertas = [];
    let esValido = true;
    let tramoProblematico = null;
    let capacidadMaximaUsada = 0;

    // Verificar cada tramo
    Object.entries(capacidadPorTramo).forEach(([tramoIndex, peso]) => {
        const indice = parseInt(tramoIndex);
        const porcentaje = (peso / capacidadMaxima) * 100;
        capacidadMaximaUsada = Math.max(capacidadMaximaUsada, peso);

        if (peso > capacidadMaxima) {
            esValido = false;
            tramoProblematico = indice;
            
            const puntoOrigen = rutaCompleta[indice]?.nombre.split(' / ')[0] || `Punto ${indice}`;
            const puntoDestino = rutaCompleta[indice + 1]?.nombre.split(' / ')[0] || `Punto ${indice + 1}`;
            
            alertas.push({
                tipo: 'error',
                mensaje: `Sobrecarga en tramo ${puntoOrigen} → ${puntoDestino}: ${peso.toFixed(2)}kg (${porcentaje.toFixed(1)}%)`,
                tramo: indice,
                peso: peso,
                porcentaje: porcentaje
            });
        } else if (peso > capacidadMaxima * 0.8) {
            // Warning para capacidad alta pero no crítica
            const puntoOrigen = rutaCompleta[indice]?.nombre.split(' / ')[0] || `Punto ${indice}`;
            const puntoDestino = rutaCompleta[indice + 1]?.nombre.split(' / ')[0] || `Punto ${indice + 1}`;
            
            alertas.push({
                tipo: 'warning',
                mensaje: `Capacidad alta en tramo ${puntoOrigen} → ${puntoDestino}: ${peso.toFixed(2)}kg (${porcentaje.toFixed(1)}%)`,
                tramo: indice,
                peso: peso,
                porcentaje: porcentaje
            });
        }
    });

    return {
        esValido,
        alertas,
        capacidadPorTramo,
        tramoProblematico,
        capacidadMaximaUsada
    };
}

/**
 * Función auxiliar para obtener nombre de sucursal (ya existe pero agregamos por completitud)
 */
function obtenerNombreSucursal(sucursalId) {
    // Buscar en origen seleccionado
    if (origenSeleccionado && parseInt(origenSeleccionado.id) === sucursalId) {
        return origenSeleccionado.nombre.split(' / ')[0];
    }

    // Buscar en destino seleccionado
    if (destinoSeleccionado && parseInt(destinoSeleccionado.id) === sucursalId) {
        return destinoSeleccionado.nombre.split(' / ')[0];
    }

    // Buscar en escalas
    const escala = escalas.find(e => parseInt(e.id) === sucursalId);
    if (escala) {
        return escala.nombre.split(' / ')[0];
    }

    // Buscar en agencias
    const agencia = agencias.find(a => parseInt(a.id) === sucursalId);
    if (agencia) {
        return agencia.nombre.split(' / ')[0];
    }

    return `Sucursal ${sucursalId}`;
}

/**
 * Función para depurar capacidad detallada (para debugging)
 */
function depurarCapacidadDetallada() {
    if (!vehiculoSeleccionado || paquetesAsignados.length === 0) {
        console.log('⚠️ No hay vehículo seleccionado o paquetes asignados para depurar');
        return;
    }

    const vehiculo = vehiculos.find(v => v.unidadid === vehiculoSeleccionado);
    const rutaCompleta = crearRutaCompleta(origenSeleccionado, destinoSeleccionado, escalas);
    const capacidadPorTramos = calcularCapacidadPorTramos(paquetesAsignados, rutaCompleta);

    console.log('🔍 DEPURACIÓN DE CAPACIDAD DETALLADA');
    console.log('===================================');
    console.log(`🚚 Vehículo: ${vehiculo.nombre_unidad} (${vehiculo.capacidad} kg)`);
    console.log(`📦 Paquetes asignados: ${paquetesAsignados.length}`);
    console.log(`🗺️ Tramos en ruta: ${rutaCompleta.length - 1}`);
    
    console.log('\n📊 Capacidad por tramo:');
    Object.entries(capacidadPorTramos).forEach(([tramoIndex, peso]) => {
        const indice = parseInt(tramoIndex);
        const puntoOrigen = rutaCompleta[indice]?.nombre.split(' / ')[0] || `Punto ${indice}`;
        const puntoDestino = rutaCompleta[indice + 1]?.nombre.split(' / ')[0] || `Punto ${indice + 1}`;
        const porcentaje = (peso / vehiculo.capacidad) * 100;
        
        console.log(`   Tramo ${indice + 1}: ${puntoOrigen} → ${puntoDestino}`);
        console.log(`   Peso: ${peso.toFixed(2)}kg (${porcentaje.toFixed(1)}%)`);
    });

    console.log('\n📋 Detalle de paquetes:');
    paquetesAsignados.forEach((paquete, index) => {
        console.log(`   ${index + 1}. ${paquete.tracking} - ${paquete.peso}kg`);
        console.log(`      Carga en: ${paquete.punto_carga}, Descarga en: ${paquete.punto_descarga}`);
        console.log(`      Tramos ocupados: ${paquete.tramos_ocupados || 'No calculados'}`);
    });
}

/**
 * Función auxiliar para validar todo el formulario
 */
function validarFormularioCompleto() {
    const fecha = document.getElementById('fecha').value;
    const hora = document.getElementById('hora').value;
    const origen = document.getElementById('origenSelect').value;
    const destino = document.getElementById('destinoSelect').value;

    const puedeGuardar = fecha && hora && origen && destino &&
        vehiculoSeleccionado &&
        empleadosAsignados.length > 0 &&
        paquetesAsignados.length > 0;

    const btnGuardar = document.getElementById('btnGuardar');
    if (btnGuardar) {
        btnGuardar.disabled = !puedeGuardar;

        // Actualizar color del botón
        if (puedeGuardar) {
            btnGuardar.style.backgroundColor = '#28a745';
            btnGuardar.style.cursor = 'pointer';
        } else {
            btnGuardar.style.backgroundColor = '#6c757d';
            btnGuardar.style.cursor = 'not-allowed';
        }
    }
}

/**
 * Función para actualizar información de paquetes (versión mejorada)
 */
function actualizarInfoPaquetes(paquetes = []) {
    const infoPaquetes = document.getElementById('infoPaquetes');
    if (!infoPaquetes) return;

    if (!paquetes || paquetes.length === 0) {
        infoPaquetes.innerHTML = `
            <i class="fa-solid fa-info-circle"></i>
            No hay paquetes disponibles para esta ruta. 
            ${escalas.length === 0 ? 'Puede agregar escalas para incluir más paquetes.' : ''}
        `;
        infoPaquetes.className = 'alert alert-warning';
        return;
    }

    // Calcular estadísticas
    const stats = paquetes.reduce((acc, paquete) => {
        acc[paquete.tipo] = (acc[paquete.tipo] || 0) + 1;
        acc.pesoTotal += paquete.peso;
        return acc;
    }, { pesoTotal: 0 });

    const statsText = Object.entries(stats)
        .filter(([key]) => key !== 'pesoTotal')
        .map(([tipo, cantidad]) => {
            const nombres = {
                'largo_recorrido': 'Viaje completo',
                'entrega_intermedia': 'Entrega en escala',
                'recojo_intermedio': 'Recojo en escala',
                'entre_escalas': 'Entre escalas'
            };
            return `${nombres[tipo] || tipo}: ${cantidad}`;
        }).join(', ');

    infoPaquetes.innerHTML = `
        <i class="fa-solid fa-check-circle"></i>
        <strong>${paquetes.length} paquetes disponibles</strong> 
        (Peso total: ${stats.pesoTotal.toFixed(2)} kg)<br>
        <small style="color: #666;">${statsText}</small>
    `;
    infoPaquetes.className = 'alert alert-info';
}

function generarControlCapacidadHTML(vehiculo, rutaCompleta, paquetesAsignados) {
    const controlContainer = document.getElementById('controlCapacidadTramos');
    if (!controlContainer) return;

    // Calcular capacidad por tramos
    const capacidadPorTramos = calcularCapacidadPorTramos(paquetesAsignados, rutaCompleta);
    const capacidadMaxima = parseFloat(vehiculo.capacidad);
    const capacidadMaximaUsada = Math.max(...Object.values(capacidadPorTramos));
    const porcentajeGeneral = (capacidadMaximaUsada / capacidadMaxima) * 100;

    // Determinar clase de estado general
    let claseEstadoGeneral = 'dentro-limite';
    if (porcentajeGeneral >= 100) {
        claseEstadoGeneral = 'excede-limite';
    } else if (porcentajeGeneral >= 80) {
        claseEstadoGeneral = 'cerca-limite';
    }

    // Generar HTML
    controlContainer.innerHTML = `
        <div class="vehiculo-control-card">
            <!-- Resumen del vehículo -->
            <div class="vehiculo-resumen">
                <div class="vehiculo-icon">
                    🚚
                </div>
                <div class="vehiculo-info">
                    <h3>${vehiculo.nombre_unidad}</h3>
                    <div class="vehiculo-tag">
                        ${paquetesAsignados.length} paquetes asignados
                    </div>
                </div>
                <div class="capacidad-general">
                    ${capacidadMaximaUsada.toFixed(2)} / ${capacidadMaxima.toFixed(2)} kg
                    <br>
                    <small style="color: #666;">(${porcentajeGeneral.toFixed(1)}% máximo)</small>
                </div>
            </div>

            <!-- Barra de capacidad general -->
            <div class="barra-capacidad-general">
                <div class="barra-fondo">
                    <div class="barra-relleno ${claseEstadoGeneral}" style="width: ${Math.min(porcentajeGeneral, 100)}%"></div>
                </div>
            </div>

            <!-- Detalle por tramos -->
            <div class="detalle-tramos">
                <div class="detalle-header">
                    <span class="detalle-icon">📊</span>
                    <h4>Capacidad por tramos de ruta</h4>
                </div>
                
                <div class="tabla-tramos">
                    <div class="tabla-header">
                        <div>Tramo</div>
                        <div>Peso transportado</div>
                        <div>Estado</div>
                    </div>
                    ${generarFilasTramos(rutaCompleta, capacidadPorTramos, capacidadMaxima)}
                </div>
            </div>
        </div>
    `;

    // Mostrar el control
    controlContainer.style.display = 'block';
}



function agregarEscalaDesdeMapa(idAgencia) {
    // Verificar que no sea origen o destino
    if (origenSeleccionado && idAgencia == origenSeleccionado.id) {
        alert("No puede agregar la sucursal de origen como escala");
        return;
    }
    
    if (destinoSeleccionado && idAgencia == destinoSeleccionado.id) {
        alert("No puede agregar la sucursal de destino como escala");
        return;
    }
    
    // Verificar límite máximo
    if (escalas.length >= MAX_ESCALAS) {
        alert(`Máximo ${MAX_ESCALAS} escalas permitidas`);
        return;
    }

    const agencia = agencias.find(a => a.id === parseInt(idAgencia));
    
    if (!agencia) {
        alert("No se encontró la agencia.");
        return;
    }

    if (escalas.some(e => e.id === idAgencia)) {
        alert("Esta agencia ya ha sido agregada como escala.");
        return;
    }

    escalas.push(agencia);
    actualizarEscalas();
    mostrarAgenciasEnMapa(); // Actualizar marcadores
    actualizarRutaEnMapa();
    
    // Recargar paquetes con las nuevas escalas
    cargarPaquetesParaRuta();
}

function eliminarEscalaDesdeMapa(idAgencia) {
    escalas = escalas.filter(e => e.id !== parseInt(idAgencia));
    actualizarEscalas();
    mostrarAgenciasEnMapa(); // Actualizar marcadores
    actualizarRutaEnMapa();
    
    // Recargar paquetes sin la escala eliminada
    cargarPaquetesParaRuta();
}


function actualizarEscalas() {
    const contenedor = document.getElementById('escalasLista');
    
    if (escalas.length === 0) {
        contenedor.innerHTML = '<span style="color: #666; font-style: italic;">No hay escalas programadas</span>';
    } else {
        contenedor.innerHTML = escalas.map((escala, index) => 
            `<div class="escala-item" draggable="true" ondragstart="iniciarArrastre(event, ${index})" ondragover="permitirSoltar(event)" ondrop="soltarEscala(event, ${index})">
                <div class="escala-number">${index + 1}</div>
                <div style="flex: 1;">
                    <strong>${escala.nombre}</strong><br>
                    <small style="color: #666;">📍 ${escala.direccion}</small><br>
                    <small style="color: #888;">🏛️ ${escala.distrito}, ${escala.provincia}</small>
                </div>
                <div style="display: flex; gap: 5px;">
                    <button class="btn btn-secondary" onclick="subirEscala(${index})" style="padding: 5px 8px; font-size: 0.7rem;" title="Subir escala">
                        <i class="fa-solid fa-arrow-up"></i>
                    </button>
                    <button class="btn btn-secondary" onclick="bajarEscala(${index})" style="padding: 5px 8px; font-size: 0.7rem;" title="Bajar escala">
                        <i class="fa-solid fa-arrow-down"></i>
                    </button>
                    <button class="btn btn-danger" onclick="eliminarEscala(${escala.id})" style="padding: 5px 10px; font-size: 0.8rem;">
                        <i class="fa-solid fa-trash"></i> Quitar
                    </button>
                </div>
            </div>`
        ).join('');
    }
    
    actualizarContadorEscalas();
    actualizarRutaEnMapa();
    
    if (origenSeleccionado && destinoSeleccionado) {
        cargarPaquetesParaRuta();
    }
    
    // Actualizar control de tramos si hay vehículo seleccionado
    if (vehiculoSeleccionado) {
        actualizarControlCapacidadTramos();
    }
}


function eliminarEscala(agenciaId) {
    escalas = escalas.filter(e => e.id !== agenciaId);
    actualizarEscalas();
    mostrarAgenciasEnMapa();
    cargarPaquetesParaRuta();
}

function actualizarContadorEscalas() {
    document.getElementById('contadorEscalas').textContent = escalas.length;
}

function actualizarRutaEnMapa() {
    if (!map) return;
    
    // Limpiar ruta anterior
    if (rutaLayer) {
        map.removeLayer(rutaLayer);
        rutaLayer = null;
    }
    
    // Limpiar marcadores de escalas anteriores
    escalasMarkers.forEach(marker => map.removeLayer(marker));
    escalasMarkers = [];
    
    // Crear array de puntos para la ruta completa
    let puntosRuta = [];
    
    // Agregar origen si existe
    if (origenSeleccionado) {
        puntosRuta.push([origenSeleccionado.lat, origenSeleccionado.lng]);
    }
    
    // Agregar escalas en orden
    escalas.forEach((escala, index) => {
        if (escala.lat && escala.lng) {
            puntosRuta.push([escala.lat, escala.lng]);
            
            // Crear marcador numerado para la escala
            const marker = L.marker([escala.lat, escala.lng], {
                icon: L.divIcon({
                    className: 'marker-numero marker-escala',
                    html: `<div class="marker-numero marker-escala">${index + 1}</div>`,
                    iconSize: [30, 30],
                    iconAnchor: [15, 15]
                })
            }).addTo(map);
            
            marker.bindPopup(`
                <strong>Escala ${index + 1}: ${escala.nombre}</strong><br>
                📍 ${escala.direccion}<br>
                🏛️ ${escala.distrito}, ${escala.provincia}<br>
                <button onclick="eliminarEscala(${escala.id})" class="btn-eliminar-escala">
                    ❌ Quitar escala
                </button>
            `);
            
            escalasMarkers.push(marker);
        }
    });
    
    // Agregar destino final si existe
    if (destinoSeleccionado) {
        puntosRuta.push([destinoSeleccionado.lat, destinoSeleccionado.lng]);
    }
    
    // Crear línea de ruta si hay al menos 2 puntos
    if (puntosRuta.length >= 2) {
        rutaLayer = L.polyline(puntosRuta, { 
            color: '#007bff', 
            weight: 4,
            opacity: 0.7
        }).addTo(map);
        
        // Ajustar vista a la ruta completa
        const allMarkers = [];
        if (origenMarker) allMarkers.push(origenMarker);
        if (destinoMarker) allMarkers.push(destinoMarker);
        allMarkers.push(...escalasMarkers);
        
        if (allMarkers.length > 0) {
            const group = new L.featureGroup(allMarkers);
            map.fitBounds(group.getBounds(), { padding: [20, 20] });
        }
    }
}

// Funciones para drag & drop de escalas
let elementoArrastrado = null;

function iniciarArrastre(event, index) {
    elementoArrastrado = index;
    event.dataTransfer.effectAllowed = "move";
}

function permitirSoltar(event) {
    event.preventDefault();
}

function soltarEscala(event, index) {
    event.preventDefault();
    
    if (elementoArrastrado !== null && elementoArrastrado !== index) {
        // Reordenar escalas
        const escalaMovida = escalas[elementoArrastrado];
        escalas.splice(elementoArrastrado, 1);
        escalas.splice(index, 0, escalaMovida);
        
        actualizarEscalas();
        actualizarRutaEnMapa();
    }
    
    elementoArrastrado = null;
}

// Funciones para reordenar escalas
function subirEscala(index) {
    if (index === 0) {
        alert('Esta escala ya se encuentra en la primera posición');
        return;
    }
    
    // Intercambiar posiciones
    const temp = escalas[index];
    escalas[index] = escalas[index - 1];
    escalas[index - 1] = temp;
    
    actualizarEscalas();
    actualizarRutaEnMapa();
}

function bajarEscala(index) {
    if (index === escalas.length - 1) {
        alert('Esta escala ya se encuentra en la última posición');
        return;
    }
    
    // Intercambiar posiciones
    const temp = escalas[index];
    escalas[index] = escalas[index + 1];
    escalas[index + 1] = temp;
    
    actualizarEscalas();
    actualizarRutaEnMapa();
}

function toggleRecojoSection() {
    const checkbox = document.getElementById('recojoCheckbox');
    const section = document.getElementById('recojoSection');
    
    if (checkbox.checked) {
        section.classList.add('show');
    } else {
        section.classList.remove('show');
        recojosAsignados = [];
        transaccionesRecojo.forEach(transaccion => {
            const checkbox = document.getElementById(`recojo_${transaccion.id}`);
            const item = document.querySelector(`#recojo_${transaccion.id}`).closest('.recojo-item');
            if (checkbox) checkbox.checked = false;
            if (item) item.classList.remove('selected');
        });
        actualizarRecojosAsignados();
    }
}

function showAlert(elementId, mensaje, tipo) {
    const elemento = document.getElementById(elementId);
    elemento.innerHTML = mensaje;
    elemento.className = `alert alert-${tipo} show`;
    
    // Auto-ocultar después de 5 segundos, excepto para warnings importantes
    if (tipo !== 'warning' || !mensaje.includes('30 minutos')) {
        setTimeout(() => {
            elemento.classList.remove('show');
        }, 5000);
    } else {
        // Para warnings importantes, mantener visible más tiempo
        setTimeout(() => {
            elemento.classList.remove('show');
        }, 8000);
    }
}

function hideAlert(elementId) {
    const elemento = document.getElementById(elementId);
    elemento.classList.remove('show');
}

function validarFormulario() {
    const fecha = document.getElementById('fecha').value;
    const hora = document.getElementById('hora').value;
    const origen = document.getElementById('origenSelect').value;
    const destino = document.getElementById('destinoSelect').value;
    
    // Validar fecha y hora futuras
    const ahora = new Date();
    const fechaHoraSeleccionada = new Date(`${fecha}T${hora}`);
    
    if (fechaHoraSeleccionada <= ahora) {
        showAlert('mensajeGuardado', 'La fecha y hora de salida deben ser posteriores a la actual', 'error');
        return false;
    }
    
    if (!fecha) {
        showAlert('mensajeGuardado', 'Por favor, seleccione una fecha', 'error');
        return false;
    }
    
    if (!hora) {
        showAlert('mensajeGuardado', 'Por favor, seleccione una hora', 'error');
        return false;
    }
    
    if (!origen) {
        showAlert('mensajeGuardado', 'Por favor, seleccione un origen', 'error');
        return false;
    }
    
    if (!destino) {
        showAlert('mensajeGuardado', 'Por favor, seleccione un destino', 'error');
        return false;
    }
    
    if (!vehiculoSeleccionado) {
        showAlert('mensajeGuardado', 'Por favor, seleccione un vehículo', 'error');
        return false;
    }
    
    if (empleadosAsignados.length === 0) {
        showAlert('mensajeGuardado', 'Debe asignar al menos un empleado', 'error');
        return false;
    }
    
    if (paquetesAsignados.length === 0) {
        showAlert('mensajeGuardado', 'Debe asignar al menos un paquete', 'error');
        return false;
    }
    
    return true;
}

function obtenerDatosSalida() {
    // Crear array con IDs de todas las sucursales involucradas
    const sucursalesIds = [origenSeleccionado.id, destinoSeleccionado.id];
    escalas.forEach(escala => {
        if (!sucursalesIds.includes(escala.id)) {
            sucursalesIds.push(escala.id);
        }
    });
    
    return {
        // Datos generales
        fecha: document.getElementById('fecha').value,
        hora: document.getElementById('hora').value,
        
        // Ruta
        sucursal_origen_id: origenSeleccionado.id,
        sucursal_destino_id: destinoSeleccionado.id,
        escalas_ids: escalas.map(escala => escala.id),
        sucursales_involucradas: sucursalesIds,
        
        // Recursos asignados
        vehiculo_id: vehiculoSeleccionado,
        empleados_ids: empleadosAsignados.map(emp => emp.id),
        paquetes_ids: paquetesAsignados.map(paq => paq.id),
        
        // Opcionales
        // incluye_recojos: document.getElementById('recojoCheckbox').checked,
        // recojos_ids: recojosAsignados.map(rec => rec.id),
        
        // Peso total
        peso_total: pesoTotal,
        
        // Metadata para debug
        fecha_creacion: new Date().toISOString()
    };
}

function guardarSalida() {
    if (!validarFormulario()) {
        return;
    }
    
    const datosSalida = obtenerDatosSalida();
    
    console.log('Datos completos de la salida:', datosSalida);
    
    // TODO: Aquí harías la llamada real al backend para guardar
    fetch('/insertar_salida', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
        vehiculo: {
            id: vehiculoSeleccionado,
            origen_inicio_id: parseInt(origenSeleccionado.id),
            destino_final_id: parseInt(destinoSeleccionado.id)
        },
        empleados: empleadosAsignados.map(e => e.id),
        escalas: escalas.map(e => e.id),
        paquetes: paquetesAsignados.map(p => ({ tracking: p.tracking }))
    })
})
.then(response => response.json())
.then(data => {
    if (data.salida_id) {
        showAlert('mensajeGuardado', `✅ Salida registrada correctamente. ID: ${data.salida_id}`, 'success');
    } else {
        showAlert('mensajeGuardado', `❌ Error: ${data.mensaje || 'Error desconocido'}`, 'error');
    }
})
.catch(error => {
    console.error('❌ Error en la API:', error);
    showAlert('mensajeGuardado', 'Error de conexión al guardar salida', 'error');
});

    
    // Por ahora mostrar mensaje de éxito con resumen
    const vehiculo = vehiculos.find(v => v.unidadid === vehiculoSeleccionado);
    let mensajeEscalas = '';
    if (escalas.length > 0) {
        mensajeEscalas = `, Escalas: ${escalas.map(e => e.nombre.split(' - ')[0]).join(' → ')}`;
    }
    
    let mensajeRecojos = '';
    if (datosSalida.incluye_recojos && recojosAsignados.length > 0) {
        mensajeRecojos = `, Con ${recojosAsignados.length} recojo(s) en casa`;
    }
    
    showAlert('mensajeGuardado', 
        `✅ Salida programada exitosamente para el ${datosSalida.fecha} a las ${datosSalida.hora}. 
        Ruta: ${origenSeleccionado.nombre.split(' / ')[0]} → ${destinoSeleccionado.nombre.split(' / ')[0]}. 
        Vehículo: ${vehiculo.nombre_unidad}, 
        Empleados: ${empleadosAsignados.length}, 
        Paquetes: ${paquetesAsignados.length}, 
        Peso total: ${pesoTotal}kg${mensajeEscalas}${mensajeRecojos}`, 
        'success');
}

</script>
{% endblock  %}